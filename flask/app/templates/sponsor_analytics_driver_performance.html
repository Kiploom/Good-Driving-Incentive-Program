{% extends "base.html" %}

{% block title %}Driver Performance Analytics{% endblock %}

{% block content %}
<style>
  .analytics-shell {
    max-width: 1100px;
    margin: 32px auto 48px;
    padding: 0 24px;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .analytics-header {
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
    color: var(--text-inverse);
    padding: 32px;
    border-radius: 20px;
    box-shadow: 0 16px 40px var(--shadow);
  }

  .analytics-header h1 {
    margin: 0 0 8px;
    font-size: 1.75rem;
    color: inherit;
  }

  .analytics-header p {
    margin: 0;
    color: rgba(255, 255, 255, 0.85);
  }

  .analytics-toolbar {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  .analytics-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 18px;
    padding: 24px;
    box-shadow: 0 6px 18px var(--shadow);
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  [data-theme="dark"] .analytics-card {
    border-color: var(--accent-border);
    box-shadow: 0 14px 34px var(--shadow-md);
    background: var(--bg-secondary);
    backdrop-filter: blur(6px);
  }

  .analytics-card h3 {
    margin: 0;
    font-size: 1.25rem;
    color: var(--text-primary);
  }

  .analytics-card p {
    margin: 0;
    color: var(--text-secondary);
    line-height: 1.55;
  }

  .filters {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    align-items: flex-end;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 2px 10px var(--shadow-sm);
  }

  [data-theme="dark"] .filters {
    border-color: var(--accent-border);
  }

  .filter-field {
    flex: 1 1 200px;
    min-width: 180px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .filters label {
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--text-secondary);
  }

  .filter-actions {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 16px;
  }

  .metric-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 18px;
    text-align: center;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  [data-theme="dark"] .metric-card {
    border-color: var(--accent-border);
  }

  .metric-value {
    font-size: 1.85rem;
    font-weight: 700;
    color: var(--accent);
  }

  .metric-label {
    font-size: 0.9rem;
    color: var(--text-muted);
  }

  .table-scroll {
    overflow-x: auto;
  }

  .table-scroll table {
    min-width: 100%;
  }

  .status-active {
    color: var(--success);
    font-weight: 600;
  }

  .status-inactive {
    color: var(--error);
    font-weight: 600;
  }

  .status-pending {
    color: var(--warning);
    font-weight: 600;
  }

  .points-positive {
    color: var(--success);
    font-weight: 600;
  }

  .points-negative {
    color: var(--error);
    font-weight: 600;
  }

  .empty-state {
    text-align: center;
    color: var(--text-muted);
    padding: 40px 16px;
  }

  .driver-summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 16px;
  }

  .driver-summary-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 18px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  [data-theme="dark"] .driver-summary-card {
    border-color: var(--accent-border);
  }

  .driver-summary-card h4 {
    margin: 0;
    color: var(--text-primary);
  }

  .driver-summary-card p {
    margin: 0;
    font-size: 0.9rem;
    color: var(--text-secondary);
  }

  .driver-summary-meta {
    color: var(--text-muted);
    font-size: 0.85rem;
  }

  @media (max-width: 640px) {
    .analytics-shell {
      padding: 0 18px 24px;
    }

    .analytics-header {
      padding: 24px;
    }

    .filters {
      padding: 16px;
    }
  }
</style>

<div class="analytics-shell">
  <div class="analytics-header">
    <h1>{{ sponsor.Company }} Driver Performance Analytics</h1>
    <p>
      Track and analyze your drivers' performance metrics and productivity. 
      This page displays all point change transactions for your drivers, including purchases, refunds, manual adjustments, and dispute resolutions. 
      Each row represents a point change event that occurred when a driver made a purchase, received a refund, had points adjusted, or had a dispute resolved.
    </p>
  </div>

  <div class="analytics-toolbar">
    <a class="btn" href="{{ url_for('sponsor.sponsor_analytics') }}">‚Üê Back to Analytics</a>
    <a class="btn" href="{{ url_for('sponsor.sponsor_analytics_driver_performance_pdf', date_from=date_from, date_to=date_to) }}" style="background: var(--accent); color: white;">
      <i class="fas fa-file-pdf"></i>
      Export PDF
    </a>
    <a class="btn" href="{{ url_for('sponsor.sponsor_analytics_driver_performance_csv', date_from=date_from, date_to=date_to) }}" style="background: var(--accent); color: white;">
      <i class="fas fa-file-csv"></i>
      Export CSV
    </a>
  </div>

  <form class="filters" method="get">
    <div class="filter-field">
      <label for="date_from">From Date</label>
      <input type="date" name="date_from" id="date_from" value="{{ date_from or '' }}" onchange="this.form.submit()">
    </div>

    <div class="filter-field">
      <label for="date_to">To Date</label>
      <input type="date" name="date_to" id="date_to" value="{{ date_to or '' }}" onchange="this.form.submit()">
    </div>

    <div class="filter-actions">
      <button class="btn" type="submit">Apply Filters</button>
      <a href="{{ url_for('sponsor.sponsor_analytics_driver_performance') }}" class="btn btn-secondary">Reset Filters</a>
    </div>
  </form>

  <div class="analytics-card">
    <h3>Your Drivers' Performance Metrics</h3>
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-value">{{ rows|length }}</div>
        <div class="metric-label">Total Records</div>
      </div>
      <div class="metric-card">
        <div class="metric-value">
          {% set unique_drivers = rows|map(attribute='0')|unique|list|length %}
          {{ unique_drivers }}
        </div>
        <div class="metric-label">Active Drivers</div>
      </div>
      <div class="metric-card">
        <div class="metric-value">
          {% set total_points = rows|selectattr('2')|map(attribute='2.DeltaPoints')|sum %}
          {{ total_points or 0 }}
        </div>
        <div class="metric-label">Total Points Issued</div>
      </div>
      <div class="metric-card">
        <div class="metric-value">
          {% if unique_drivers > 0 %}
            {{ "%.1f"|format((total_points or 0) / unique_drivers) }}
          {% else %}
            0
          {% endif %}
        </div>
        <div class="metric-label">Avg Points per Driver</div>
      </div>
    </div>
  </div>

  <div class="analytics-card">
    <h3>Driver Performance Data</h3>
    <p style="margin: 0 0 16px 0; color: var(--text-secondary); font-size: 0.95rem; line-height: 1.5;">
      Detailed summary of driver point change transactions and related metadata. 
      <strong>New entries are created automatically when:</strong> drivers make purchases (points deducted), orders are refunded or cancelled (points returned), you manually adjust points, or point disputes are approved (points restored). 
      Drivers without any point change history will show "N/A" for Points Change, Reason, and Date columns.
    </p>
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th>Driver Name</th>
            <th>Email</th>
            <th>Status</th>
            <th>Age</th>
            <th>Gender</th>
            <th>Points Change</th>
            <th>Reason</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody>
          {% for driver, account, point_change in rows %}
          <tr>
            <td>{{ account.FirstName }} {{ account.LastName }}</td>
            <td>{{ account.Email }}</td>
            <td>
              <span class="status-{{ driver.Status.lower() }}">{{ driver.Status }}</span>
            </td>
            <td>{{ driver.Age or 'N/A' }}</td>
            <td>{{ driver.Gender or 'N/A' }}</td>
            <td>
              {% if point_change %}
                <span class="points-{{ 'positive' if point_change.DeltaPoints > 0 else 'negative' }}">
                  {{ '+' if point_change.DeltaPoints > 0 else '' }}{{ point_change.DeltaPoints }}
                </span>
              {% else %}
                N/A
              {% endif %}
            </td>
            <td>{{ point_change.Reason if point_change else 'N/A' }}</td>
            <td>{{ point_change.CreatedAt.strftime('%Y-%m-%d %H:%M') if point_change else 'N/A' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {% if not rows %}
  <div class="analytics-card">
    <p class="empty-state">
      No driver performance data found for the selected date range.
    </p>
  </div>
  {% endif %}

  <div class="analytics-card">
    <h3>Driver Summary</h3>
    <div class="driver-summary-grid">
      {% set driver_summary = {} %}
      {% for driver, account, point_change in rows %}
        {% set driver_id = driver.DriverID %}
        {% if driver_id not in driver_summary %}
          {% set _ = driver_summary.update({driver_id: {'name': account.FirstName + ' ' + account.LastName, 'email': account.Email, 'status': driver.Status, 'total_points': 0, 'transaction_count': 0}}) %}
        {% endif %}
        {% if point_change %}
          {% set _ = driver_summary[driver_id].update({'total_points': driver_summary[driver_id]['total_points'] + point_change.DeltaPoints, 'transaction_count': driver_summary[driver_id]['transaction_count'] + 1}) %}
        {% endif %}
      {% endfor %}

      {% for driver_id, summary in driver_summary.items() %}
      <div class="driver-summary-card">
        <h4>{{ summary.name }}</h4>
        <p class="driver-summary-meta">{{ summary.email }}</p>
        <p>Status: <span class="status-{{ summary.status.lower() }}">{{ summary.status }}</span></p>
        <p>
          Total Points:
          <span class="points-{{ 'positive' if summary.total_points > 0 else 'negative' if summary.total_points < 0 else '' }}">
            {{ '+' if summary.total_points > 0 else '' }}{{ summary.total_points }}
          </span>
        </p>
        <p>Transactions: {{ summary.transaction_count }}</p>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}
