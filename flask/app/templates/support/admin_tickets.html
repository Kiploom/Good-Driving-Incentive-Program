{% extends "support/base.html" %}

{% block title %}Admin - All Tickets{% endblock %}

{% block content %}
<div class="settings-page support-page-shell">
  <div class="settings-container support-wrapper">
    <div class="admin-support-container support-theme">
      <div class="admin-header">
        <div class="header-content">
          <h1><i class="fas fa-ticket-alt"></i> All Support Tickets</h1>
          <p class="header-subtitle">Review every open conversation across driver and sponsor accounts.</p>
        </div>
        <div class="header-actions">
          <a href="{{ url_for('support_ui.admin_categories') }}" class="btn btn-outline-primary">
            <i class="fas fa-tags"></i> Manage Categories
          </a>
        </div>
      </div>

      <div class="filters-section">
        <div class="filters-header">
          <h2><i class="fas fa-filter"></i> Filter &amp; Search Tickets</h2>
          <div class="filter-toggle">
            <button type="button" class="btn btn-outline-secondary btn-sm" id="toggleFilters">
              <i class="fas fa-chevron-down"></i> Toggle Filters
            </button>
          </div>
        </div>

        <div class="filters-content" id="filtersContent">
          <form method="GET" action="{{ url_for('support_ui.admin_tickets_list') }}" class="filters-form">
            <div class="filters-grid">
              <div class="filter-group">
                <label for="q" class="filter-label">
                  <i class="fas fa-search"></i> Search
                </label>
                <input type="text"
                       id="q"
                       name="q"
                       value="{{ q_filter }}"
                       placeholder="Search by subject or message content…"
                       class="form-control">
              </div>

              <div class="filter-group">
                <label for="source" class="filter-label">
                  <i class="fas fa-users"></i> Source
                </label>
                <select id="source" name="source" class="form-select">
                  <option value="">All Sources</option>
                  <option value="sponsor" {% if source_filter == 'sponsor' %}selected{% endif %}>Sponsor</option>
                  <option value="driver" {% if source_filter == 'driver' %}selected{% endif %}>Driver</option>
                </select>
              </div>

              <div class="filter-group">
                <label for="status" class="filter-label">
                  <i class="fas fa-flag"></i> Status
                </label>
                <select id="status" name="status" class="form-select">
                  <option value="">All Statuses</option>
                  <option value="new" {% if status_filter == 'new' %}selected{% endif %}>New</option>
                  <option value="open" {% if status_filter == 'open' %}selected{% endif %}>Open</option>
                  <option value="waiting" {% if status_filter == 'waiting' %}selected{% endif %}>Waiting</option>
                  <option value="resolved" {% if status_filter == 'resolved' %}selected{% endif %}>Resolved</option>
                  <option value="closed" {% if status_filter == 'closed' %}selected{% endif %}>Closed</option>
                </select>
              </div>

              <div class="filter-group">
                <label for="category_id" class="filter-label">
                  <i class="fas fa-tag"></i> Category
                </label>
                <select id="category_id" name="category_id" class="form-select">
                  <option value="">All Categories</option>
                  {% for category in categories %}
                  <option value="{{ category.CategoryID }}"
                          {% if category_filter == category.CategoryID %}selected{% endif %}>
                    {{ category.Name }}
                  </option>
                  {% endfor %}
                </select>
              </div>

              <div class="filter-group">
                <label for="from" class="filter-label">
                  <i class="fas fa-calendar"></i> From Date
                </label>
                <input type="date"
                       id="from"
                       name="from"
                       value="{{ from_date }}"
                       class="form-control">
              </div>

              <div class="filter-group">
                <label for="to" class="filter-label">
                  <i class="fas fa-calendar"></i> To Date
                </label>
                <input type="date"
                       id="to"
                       name="to"
                       value="{{ to_date }}"
                       class="form-control">
              </div>

              <div class="filter-group checkbox-group">
                <div class="form-check">
                  <input class="form-check-input"
                         type="checkbox"
                         id="show_closed"
                         name="show_closed"
                         value="true"
                         {% if show_closed %}checked{% endif %}>
                  <label class="form-check-label" for="show_closed">
                    <i class="fas fa-archive"></i> Include closed tickets
                  </label>
                </div>
              </div>
            </div>

            <div class="filter-actions">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-search"></i> Apply Filters
              </button>
              <a href="{{ url_for('support_ui.admin_tickets_list') }}" class="btn btn-outline-secondary">
                <i class="fas fa-times"></i> Clear All
              </a>
            </div>
          </form>
        </div>
      </div>

      <div class="tickets-section admin-tickets">
        <div class="tickets-header">
          <h2><i class="fas fa-ticket-alt"></i> Support Tickets</h2>
          <div class="tickets-count">
            <span class="badge bg-primary">{{ tickets|length }} found</span>
          </div>
        </div>

        {% if tickets %}
        <div class="tickets-grid">
          {% for ticket in tickets %}
          <div class="ticket-card {{ ticket.Status }}">
            <div class="ticket-card-header">
              <div class="ticket-priority">
                <span class="status-badge {{ ticket.Status }}">
                  <i class="fas fa-circle"></i> {{ ticket.Status|title }}
                </span>
              </div>
              <div class="ticket-id">
                #{{ ticket.TicketID[:8] }}
              </div>
            </div>

            <div class="ticket-card-body">
              <h3 class="ticket-title">
                <a href="{{ url_for('support_ui.admin_ticket_detail', ticket_id=ticket.TicketID) }}" class="ticket-link">
                  {{ ticket.Title }}
                </a>
              </h3>
              <p class="ticket-preview">
                {{ ticket.Body[:160] }}{% if ticket.Body|length > 160 %}…{% endif %}
              </p>
              <div class="ticket-meta">
                <div class="meta-item">
                  <i class="fas fa-user-circle"></i>
                  <span class="meta-label">Owner:</span>
                  <span class="meta-value">{{ ticket.owner_name }}</span>
                </div>
                <div class="meta-item">
                  <i class="fas fa-{{ 'building' if ticket.Source == 'sponsor' else 'truck' }}"></i>
                  <span class="meta-label">Source:</span>
                  <span class="meta-value">{{ ticket.Source|title }}</span>
                </div>
                <div class="meta-item">
                  <i class="fas fa-clock"></i>
                  <span class="meta-label">Updated:</span>
                  <span class="meta-value">{{ ticket.UpdatedAt.strftime('%m/%d/%Y %I:%M %p') }}</span>
                </div>
                <div class="meta-item">
                  <i class="fas fa-comments"></i>
                  <span class="meta-label">Messages:</span>
                  <span class="meta-value">{{ ticket.messages.count() }}</span>
                </div>
                {% if ticket.category %}
                <div class="meta-item">
                  <i class="fas fa-tag"></i>
                  <span class="meta-label">Category:</span>
                  <span class="meta-value">{{ ticket.category.Name }}</span>
                </div>
                {% endif %}
              </div>
            </div>

            <div class="ticket-card-footer">
              <div class="ticket-actions">
                <a href="{{ url_for('support_ui.admin_ticket_detail', ticket_id=ticket.TicketID) }}"
                   class="btn btn-primary btn-sm">
                  <i class="fas fa-eye"></i> View Details
                </a>
                {% if ticket.Status == 'new' %}
                <span class="attention-pill">
                  <i class="fas fa-bell"></i> Needs attention
                </span>
                {% elif ticket.Status == 'waiting' %}
                <span class="attention-pill waiting">
                  <i class="fas fa-hourglass-half"></i> Waiting on user
                </span>
                {% endif %}
              </div>
              <div class="ticket-age">
                <i class="fas fa-calendar-alt"></i>
                {{ (moment().subtract(ticket.CreatedAt).days) if moment else 'Recently' }} days open
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
          <div class="empty-icon">
            <i class="fas fa-ticket-alt"></i>
          </div>
          <h3>No tickets found</h3>
          <p class="empty-message">
            {% if q_filter or source_filter or status_filter or category_filter or from_date or to_date or show_closed %}
              Nothing matches the current filters. Adjust your search criteria and try again.
            {% else %}
              There are no support tickets in the system yet.
            {% endif %}
          </p>
          <div class="empty-actions">
            {% if not (q_filter or source_filter or status_filter or category_filter or from_date or to_date or show_closed) %}
            <a href="{{ url_for('support_ui.admin_categories') }}" class="btn btn-primary">
              <i class="fas fa-tags"></i> Set Up Categories
            </a>
            {% else %}
            <a href="{{ url_for('support_ui.admin_tickets_list') }}" class="btn btn-outline-primary">
              <i class="fas fa-times"></i> Clear Filters
            </a>
            {% endif %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const toggleBtn = document.getElementById('toggleFilters');
  const filtersContent = document.getElementById('filtersContent');

  if (toggleBtn && filtersContent) {
    filtersContent.style.display = 'none';
    toggleBtn.innerHTML = '<i class="fas fa-chevron-right"></i> Show Filters';

    toggleBtn.addEventListener('click', function() {
      if (filtersContent.style.display === 'none') {
        filtersContent.style.display = 'block';
        toggleBtn.innerHTML = '<i class="fas fa-chevron-down"></i> Hide Filters';
      } else {
        filtersContent.style.display = 'none';
        toggleBtn.innerHTML = '<i class="fas fa-chevron-right"></i> Show Filters';
      }
    });
  }

  const filterInputs = document.querySelectorAll('#source, #status, #category_id, #show_closed');
  filterInputs.forEach(input => {
    input.addEventListener('change', function() {
      this.form.submit();
    });
  });
});
</script>
{% endblock %}
