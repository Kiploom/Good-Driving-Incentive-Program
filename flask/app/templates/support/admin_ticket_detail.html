{% extends "support/base.html" %}

{% block title %}Admin - {{ ticket.Title }}{% endblock %}

{% block content %}
<div class="settings-page support-page-shell">
  <div class="settings-container support-wrapper">
    <div class="admin-support-container support-theme admin-ticket-shell">
      <div class="admin-ticket-header support-card">
        <div class="support-card-body ticket-header-body">
          <div class="ticket-header-info">
            <h1>{{ ticket.Title }}</h1>
            <p>
              Ticket #{{ ticket.TicketID[:8] }} • {{ ticket.Status|title }} • {{ ticket.Source|title }}
            </p>
          </div>
          <div class="ticket-header-actions">
            <a href="{{ url_for('support_ui.admin_support_hub') }}" class="btn btn-secondary">
              <i class="fas fa-arrow-left"></i> Back to Hub
            </a>
            <a href="{{ url_for('support_ui.admin_tickets_list') }}" class="btn btn-outline-secondary">
              <i class="fas fa-list"></i> All Tickets
            </a>
          </div>
        </div>
      </div>

      <div class="admin-ticket-layout">
        <div class="admin-ticket-main">
          <div class="support-card">
            <div class="support-card-header">
              <h3><i class="fas fa-info-circle"></i> Ticket Information</h3>
            </div>
            <div class="support-card-body">
              <div class="ticket-info-grid">
                <div class="info-item">
                  <span class="info-label">Owner</span>
                  <span class="info-value">{{ ticket.owner_name }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Source</span>
                  <span class="info-value">
                    <i class="fas fa-{{ 'building' if ticket.Source == 'sponsor' else 'truck' }}"></i>
                    {{ ticket.Source|title }}
                  </span>
                </div>
                <div class="info-item">
                  <span class="info-label">Created</span>
                  <span class="info-value">{{ ticket.CreatedAt.strftime('%m/%d/%Y %I:%M %p') }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Updated</span>
                  <span class="info-value">{{ ticket.UpdatedAt.strftime('%m/%d/%Y %I:%M %p') }}</span>
                </div>
                {% if ticket.ClosedAt %}
                <div class="info-item">
                  <span class="info-label">Closed</span>
                  <span class="info-value">{{ ticket.ClosedAt.strftime('%m/%d/%Y %I:%M %p') }}</span>
                </div>
                {% endif %}
                {% if ticket.category %}
                <div class="info-item">
                  <span class="info-label">Category</span>
                  <span class="info-value">{{ ticket.category.Name }}</span>
                </div>
                {% endif %}
                <div class="info-item status">
                  <span class="info-label">Status</span>
                  <span class="ticket-status {{ ticket.Status }}">{{ ticket.Status|title }}</span>
                </div>
              </div>
              <div class="ticket-description">
                <h4><i class="fas fa-align-left"></i> Description</h4>
                <div class="message-body">{{ ticket.Body }}</div>
              </div>
            </div>
          </div>

          <div class="support-card">
            <div class="support-card-header">
              <h3><i class="fas fa-comments"></i> Conversation ({{ messages|length }} messages)</h3>
            </div>
            <div class="support-card-body">
              {% if messages %}
              <div class="message-thread">
                {% for message in messages %}
                <div class="message-bubble {{ message.AuthorRole }}">
                  <div class="message-header">
                    <span class="message-author">
                      {% if message.AuthorRole == 'admin' %}
                      <i class="fas fa-user-shield text-primary"></i>
                      {% elif message.AuthorRole == 'sponsor' %}
                      <i class="fas fa-building text-success"></i>
                      {% else %}
                      <i class="fas fa-user text-warning"></i>
                      {% endif %}
                      {{ message.author_name }} <span class="message-role">({{ message.AuthorRole|title }})</span>
                    </span>
                    <span class="message-time">{{ message.CreatedAt.strftime('%m/%d/%Y %I:%M %p') }}</span>
                  </div>
                  <div class="message-body">{{ message.Body }}</div>
                </div>
                {% endfor %}
              </div>
              {% else %}
              <div class="empty-state">
                <i class="fas fa-comments"></i>
                <h4>No messages yet</h4>
                <p>Start the conversation by responding below.</p>
              </div>
              {% endif %}
            </div>
          </div>
        </div>

        <aside class="admin-ticket-sidebar">
          <div class="support-card sticky-card">
            <div class="support-card-header">
              <h3><i class="fas fa-cogs"></i> Admin Actions</h3>
            </div>
            <div class="support-card-body">
              {% if ticket.Status != 'closed' %}
              <form method="POST" action="{{ url_for('support_ui.admin_update_ticket', ticket_id=ticket.TicketID) }}" class="ticket-update-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                <div class="form-group">
                  <label for="status" class="form-label">
                    <strong>Status</strong>
                  </label>
                  <select class="form-control" id="status" name="status" required>
                    <option value="new" {% if ticket.Status == 'new' %}selected{% endif %}>New</option>
                    <option value="open" {% if ticket.Status == 'open' %}selected{% endif %}>Open</option>
                    <option value="waiting" {% if ticket.Status == 'waiting' %}selected{% endif %}>Waiting</option>
                    <option value="resolved" {% if ticket.Status == 'resolved' %}selected{% endif %}>Resolved</option>
                    <option value="closed" {% if ticket.Status == 'closed' %}selected{% endif %}>Closed</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="category_id" class="form-label">
                    <strong>Category</strong>
                  </label>
                  <select class="form-control" id="category_id" name="category_id">
                    <option value="">No Category</option>
                    {% for category in categories %}
                    <option value="{{ category.CategoryID }}"
                            {% if ticket.category and ticket.category.CategoryID == category.CategoryID %}selected{% endif %}>
                      {{ category.Name }}
                    </option>
                    {% endfor %}
                  </select>
                </div>

                <div class="form-group">
                  <label for="message_body" class="form-label">
                    <strong>Admin Response</strong>
                  </label>
                  <textarea class="form-control"
                            id="message_body"
                            name="message_body"
                            rows="4"
                            placeholder="Share an update or request additional information."></textarea>
                  <div class="form-help">Leave blank to update status or category without posting a message.</div>
                </div>

                <div class="d-grid">
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Changes
                  </button>
                </div>
              </form>
              {% else %}
              <div class="alert alert-info mb-0">
                <i class="fas fa-info-circle"></i>
                This ticket is closed and cannot be modified.
              </div>
              {% endif %}
            </div>
          </div>

          <div class="support-card sticky-card">
            <div class="support-card-header">
              <h3><i class="fas fa-envelope"></i> Email Ticket Owner</h3>
            </div>
            <div class="support-card-body email-card-body">
              <p class="email-recipient">
                <strong>To:</strong>
                {{ ticket.owner_email if ticket.owner_email and ticket.owner_email != 'Unknown' else 'Email unavailable' }}
              </p>
              {% if ticket.owner_email and ticket.owner_email != 'Unknown' %}
              <form method="POST" action="{{ url_for('support_ui.admin_email_ticket_owner', ticket_id=ticket.TicketID) }}" class="email-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="form-group">
                  <label for="email_subject" class="form-label"><strong>Subject</strong></label>
                  <input type="text" class="form-control" id="email_subject" name="email_subject" value="Re: {{ ticket.Title }}">
                </div>
                <div class="form-group">
                  <label for="email_body" class="form-label"><strong>Message</strong></label>
                  <textarea class="form-control" id="email_body" name="email_body" rows="5" placeholder="Write your email response..."></textarea>
                </div>
                <div class="form-group form-check">
                  <input class="form-check-input" type="checkbox" id="log_email" name="log_email" value="on" checked>
                  <label class="form-check-label" for="log_email">
                    Log this email to the conversation history
                  </label>
                </div>
                <div class="d-grid">
                  <button type="submit" class="btn btn-success">
                    <i class="fas fa-paper-plane"></i> Send Email
                  </button>
                </div>
              </form>
              {% else %}
              <div class="alert alert-warning mb-0">
                <i class="fas fa-exclamation-triangle"></i>
                No email address is available for this ticket owner.
              </div>
              {% endif %}
            </div>
          </div>

          <div class="support-card sticky-card">
            <div class="support-card-header">
              <h3><i class="fas fa-chart-bar"></i> Ticket Snapshot</h3>
            </div>
            <div class="support-card-body ticket-stats-grid">
              <div class="mini-stat">
                <span class="mini-stat-label">Messages</span>
                <span class="mini-stat-value">{{ messages|length }}</span>
              </div>
              <div class="mini-stat">
                <span class="mini-stat-label">Days open</span>
                <span class="mini-stat-value">{{ ((ticket.UpdatedAt - ticket.CreatedAt).days) + 1 }}</span>
              </div>
              <div class="mini-stat">
                <span class="mini-stat-label">Created</span>
                <span class="mini-stat-value">{{ ticket.CreatedAt.strftime('%m/%d') }}</span>
              </div>
              <div class="mini-stat">
                <span class="mini-stat-label">Updated</span>
                <span class="mini-stat-value">{{ ticket.UpdatedAt.strftime('%m/%d') }}</span>
              </div>
              {% if ticket.category %}
              <div class="mini-stat wide">
                <span class="mini-stat-label">Category</span>
                <span class="mini-stat-chip">
                  <i class="fas fa-tag"></i> {{ ticket.category.Name }}
                </span>
              </div>
              {% endif %}
            </div>
          </div>
        </aside>
      </div>
    </div>
  </div>
</div>
{% endblock %}