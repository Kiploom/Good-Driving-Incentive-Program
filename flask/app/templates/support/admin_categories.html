{% extends "support/base.html" %}

{% block title %}Admin - Manage Categories{% endblock %}

{% block content %}
<div class="settings-page support-page-shell">
  <div class="settings-container support-wrapper">
    <div class="admin-support-container support-theme admin-categories-shell">
      <div class="admin-header">
        <div class="header-content">
          <h1><i class="fas fa-tags"></i> Manage Support Categories</h1>
          <p class="header-subtitle">Organize ticket routing with clear, themed categories.</p>
        </div>
        <div class="header-actions">
          <a href="{{ url_for('support_ui.admin_tickets_list') }}" class="btn btn-outline-primary">
            <i class="fas fa-list"></i> All Tickets
          </a>
        </div>
      </div>

      <div class="admin-categories-grid">
        <section class="support-card">
          <div class="support-card-header">
            <h3><i class="fas fa-layer-group"></i> Existing Categories</h3>
          </div>
          <div class="support-card-body">
            {% if categories %}
            <div class="admin-table-wrapper">
              <table class="admin-table">
                <thead>
                  <tr>
                    <th scope="col">Name</th>
                    <th scope="col">Created</th>
                    <th scope="col">Tickets</th>
                    <th scope="col" class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for category in categories %}
                  <tr>
                    <td data-title="Name">
                      <span class="category-name">{{ category.Name }}</span>
                    </td>
                    <td data-title="Created">
                      {{ category.CreatedAt.strftime('%m/%d/%Y') }}
                    </td>
                    <td data-title="Tickets">
                      <span class="tickets-badge">{{ category.tickets.count() }}</span>
                    </td>
                    <td data-title="Actions" class="text-end">
                      {% if category.tickets.count() == 0 %}
                      <form method="POST"
                            action="{{ url_for('support_ui.admin_delete_category', category_id=category.CategoryID) }}"
                            onsubmit="return confirm('Delete this category? Tickets cannot be recovered.');"
                            class="inline-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-link text-danger">
                          <i class="fas fa-trash"></i>
                          <span>Delete</span>
                        </button>
                      </form>
                      {% else %}
                      <span class="tag-chip in-use">
                        <i class="fas fa-lock"></i> In Use
                      </span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <div class="empty-state compact">
              <i class="fas fa-tags"></i>
              <h3>No categories yet</h3>
              <p>Create your first support category to help organize tickets.</p>
            </div>
            {% endif %}
          </div>
        </section>

        <aside class="admin-categories-sidebar">
          <div class="support-card">
            <div class="support-card-header">
              <h3><i class="fas fa-plus"></i> Create New Category</h3>
            </div>
            <div class="support-card-body">
              <form method="POST" action="{{ url_for('support_ui.admin_create_category') }}" class="category-form" id="createCategoryForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="form-group">
                  <label for="name" class="form-label"><strong>Category Name</strong></label>
                  <input type="text"
                         class="form-control"
                         id="name"
                         name="name"
                         placeholder="e.g., Technical Support"
                         required
                         maxlength="100">
                  <div class="form-help text-end" id="nameCounter">100 characters remaining</div>
                </div>

                <div class="alert alert-info">
                  <i class="fas fa-info-circle"></i>
                  <strong>Tip:</strong> Use specific names that help the support team triage requests quickly.
                </div>

                <button type="submit" class="btn btn-primary w-100">
                  <i class="fas fa-plus"></i> Create Category
                </button>
              </form>
            </div>
          </div>

          <div class="support-card">
            <div class="support-card-header">
              <h3><i class="fas fa-lightbulb"></i> Category Guidelines</h3>
            </div>
            <div class="support-card-body guidelines-list">
              <h5>Good category examples</h5>
              <ul class="list-unstyled">
                <li><i class="fas fa-check text-success"></i> Technical Support</li>
                <li><i class="fas fa-check text-success"></i> Account Issues</li>
                <li><i class="fas fa-check text-success"></i> Billing Questions</li>
                <li><i class="fas fa-check text-success"></i> Feature Requests</li>
              </ul>

              <h5 class="mt-3">Best practices</h5>
              <ul class="list-unstyled">
                <li><i class="fas fa-arrow-right text-primary"></i> Keep names short and descriptive</li>
                <li><i class="fas fa-arrow-right text-primary"></i> Use title case</li>
                <li><i class="fas fa-arrow-right text-primary"></i> Avoid redundant categories</li>
                <li><i class="fas fa-arrow-right text-primary"></i> Group similar request types together</li>
              </ul>
            </div>
          </div>

          <div class="support-card">
            <div class="support-card-header">
              <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
            </div>
            <div class="support-card-body">
              <div class="d-grid gap-2">
                <a href="{{ url_for('support_ui.admin_support_hub') }}" class="btn btn-secondary">
                  <i class="fas fa-home"></i> Support Hub
                </a>
                <a href="{{ url_for('support_ui.admin_tickets_list') }}" class="btn btn-outline-primary">
                  <i class="fas fa-list"></i> View Tickets
                </a>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('createCategoryForm');
  const nameInput = document.getElementById('name');
  const counter = document.getElementById('nameCounter');

  if (nameInput && counter) {
    const updateCounter = () => {
      const remaining = 100 - nameInput.value.length;
      counter.textContent = `${remaining} characters remaining`;
      counter.classList.toggle('text-warning', remaining < 10);
    };

    updateCounter();
    nameInput.addEventListener('input', updateCounter);
  }

  if (form && nameInput) {
    form.addEventListener('submit', function(e) {
      const value = nameInput.value.trim();
      if (!value) {
        e.preventDefault();
        alert('Please enter a category name.');
        nameInput.focus();
      } else if (value.length < 2) {
        e.preventDefault();
        alert('Category name must be at least 2 characters long.');
        nameInput.focus();
      }
    });
  }
});
</script>
{% endblock %}
