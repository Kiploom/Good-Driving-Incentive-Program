{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block head %}
<style>
  .dashboard-wrap {
    max-width: 1200px;
    margin: 2rem auto;
    padding: 0 1.5rem 2.5rem;
  }

  .dashboard-summary {
    margin: 0.35rem 0 0;
    color: var(--text-secondary);
  }

  .dashboard-cards {
    margin-top: 1.5rem;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 1rem;
  }

  .dashboard-cards .card {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .dashboard-cards .card p {
    margin: 0;
    color: var(--text-secondary);
  }

  .dashboard-card-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-top: auto;
  }

  .pill {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.2rem 0.75rem;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-size: 0.8rem;
    font-weight: 600;
    letter-spacing: 0.02em;
  }

  .pill--success {
    background: var(--success-soft);
    border-color: var(--success);
    color: var(--success);
  }

  .pill--warning {
    background: var(--warning-soft);
    border-color: var(--warning);
    color: var(--warning);
  }

  .pill--info {
    background: var(--info-soft);
    border-color: var(--info);
    color: var(--info);
  }

  .pill--error {
    background: var(--error-soft);
    border-color: var(--error);
    color: var(--error);
  }

  .env-switch-card {
    gap: 1rem;
  }

  .env-switch-card form {
    display: grid;
    gap: 0.75rem;
  }

  .env-switch-card select {
    width: 100%;
    padding: 0.65rem 0.75rem;
    border: 1px solid var(--border);
    border-radius: 10px;
    background: var(--bg-input);
    color: var(--text-primary);
    font-size: 0.95rem;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .env-switch-card select:focus {
    outline: none;
    border-color: var(--accent-border);
    box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.12);
  }

  .env-switch-card hr {
    border: none;
    border-top: 1px solid var(--border);
    margin: 0.75rem 0;
  }

  .env-switch-card ul {
    margin: 0;
    padding-left: 1.1rem;
    color: var(--text-secondary);
  }

  .env-switch-card li {
    margin-bottom: 0.35rem;
  }

  .challenges-overlay,
  .achievements-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.72);
    display: none;
    align-items: flex-start;
    justify-content: center;
    overflow-y: auto;
    padding: 5rem 1rem 2rem;
    z-index: 2000;
  }

  .challenges-overlay.active,
  .achievements-overlay.active {
    display: flex;
  }

  .challenges-panel,
  .achievements-panel {
    background: rgba(15, 23, 42, 0.92);
    border: 1px solid rgba(148, 163, 184, 0.28);
    border-radius: 18px;
    width: min(880px, 95vw);
    max-height: calc(100vh - 7rem);
    box-shadow: 0 30px 60px -20px rgba(15, 23, 42, 0.45);
    animation: slideIn 0.22s ease-out;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    backdrop-filter: blur(14px);
  }

  [data-theme="light"] .challenges-panel,
  [data-theme="light"] .achievements-panel {
    background: var(--bg-card);
    border: 1px solid rgba(148, 163, 184, 0.2);
  }

  .challenges-header,
  .achievements-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
    padding: 1.5rem;
    border-bottom: 1px solid rgba(148, 163, 184, 0.18);
  }

.challenges-body,
.achievements-body {
  padding: 1.5rem 1.75rem;
  display: grid;
  gap: 1rem;
}

.challenges-panel .challenges-body,
.achievements-panel .achievements-body {
  flex: 1;
  min-height: 0;
  overflow-y: auto;
}

  .challenge-item {
    border: 1px solid rgba(148, 163, 184, 0.2);
    border-radius: 16px;
    padding: 1.25rem;
    background: rgba(30, 41, 59, 0.85);
    display: grid;
    gap: 0.75rem;
    box-shadow: 0 10px 25px -15px rgba(15, 23, 42, 0.65);
  }

  .challenge-item.active {
    background: rgba(34, 197, 94, 0.18);
    border-color: rgba(34, 197, 94, 0.55);
  }

  .challenge-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    color: var(--text-secondary);
    font-size: 0.85rem;
  }

  .challenge-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.6rem;
  }

  .challenge-actions button {
    border: none;
    border-radius: 10px;
    padding: 0.55rem 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s ease, color 0.2s ease, transform 0.2s ease;
  }

  .challenge-actions button.subscribe {
    background: linear-gradient(135deg, #38bdf8, #0ea5e9);
    color: #0b1120;
  }

  .challenge-actions button.subscribe:hover {
    transform: translateY(-1px);
    background: linear-gradient(135deg, #38bdf8, #0284c7);
  }

  .challenge-actions button.close {
    background: rgba(71, 85, 105, 0.35);
    color: #e2e8f0;
  }

  .challenge-actions button:disabled {
    opacity: 0.65;
    cursor: not-allowed;
  }

  .challenge-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    font-size: 0.75rem;
    background: var(--info-soft);
    color: var(--info);
    font-weight: 600;
  }

  .challenge-badge.subscribed,
  .challenge-badge.completed {
    background: var(--success-soft);
    color: var(--success);
  }

  .challenge-badge.optional {
    background: var(--info-soft);
    color: var(--info);
  }

  .challenges-empty {
    padding: 2.5rem 1.5rem;
    text-align: center;
    border: 1px dashed var(--border);
    border-radius: 12px;
    color: var(--text-secondary);
    background: var(--bg-secondary);
  }

.achievement-group {
  display: grid;
  gap: 0.75rem;
}

.achievement-group h4 {
  margin: 0;
  color: var(--text-primary);
}

.achievement-grid {
  display: grid;
  gap: 0.75rem;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
}

.achievement-card {
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1rem;
    background: var(--bg-secondary);
    display: grid;
    gap: 0.5rem;
  }

  .achievement-card.earned {
    border-color: var(--success);
    background: var(--success-soft);
  }

  .achievement-card h5 {
    margin: 0;
    color: var(--text-primary);
  }

  .achievement-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    font-size: 0.75rem;
    background: var(--bg-secondary);
    color: var(--text-secondary);
    font-weight: 600;
  }

  .achievement-tag.earned {
    background: var(--success-soft);
    color: var(--success);
  }

  .achievement-tag.locked {
    background: var(--info-soft);
    color: var(--info);
  }

  .achievement-requirement {
    color: var(--text-secondary);
    font-size: 0.85rem;
  }

.overlay-muted {
  color: rgba(148, 163, 184, 0.85);
  margin: 0.25rem 0 0;
  font-size: 0.95rem;
}

  @keyframes slideIn {
    from { transform: translateY(16px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  @media (max-width: 768px) {
    .dashboard-wrap {
      padding: 0 1rem 2rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-wrap">
  <h2>Welcome{% if current_user.is_authenticated %}{% set name = current_user.WholeName or current_user.Username or current_user.Email %}, {{ name }}{% endif %}</h2>
  <p class="dashboard-summary">You are logged in as a <strong>{{ role|capitalize }}</strong>.</p>

  <div class="dashboard-cards">

    {% if role == "driver" %}
    {% set ns = namespace(current=session.get("sponsor_company")) %}
    {% if ns.current is none %}
      {% for env in (driver_envs or []) %}
        {% set dsid = env.DriverSponsorID if env is not mapping or env.DriverSponsorID is defined else env.get('driverSponsorId') %}
        {% if current_driver_sponsor_id and dsid == current_driver_sponsor_id %}
          {% if env.sponsor is defined and env.sponsor and env.sponsor.Company is defined %}
            {% set ns.current = env.sponsor.Company %}
          {% elif env.sponsorName is defined and env.sponsorName %}
            {% set ns.current = env.sponsorName %}
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endif %}
    {% set leaderboard_title = (ns.current or "Sponsor") ~ " Leaderboard" %}
    <div class="card">
      <h3>üõçÔ∏è Browse Catalog</h3>
      <p>Search and browse products from your sponsor. Prices are shown as points.</p>
      <div class="dashboard-card-actions">
        <a class="btn" href="{{ url_for('driver_points_catalog.browse') }}">Browse Products</a>
      </div>
    </div>
    <div class="card">
      <h3>‚ù§Ô∏è My Favorites</h3>
      <p>View and manage your favorite products saved for later.</p>
      <div class="dashboard-card-actions">
        <a class="btn btn-danger" href="{{ url_for('driver_points_catalog.favorites_page') }}">View Favorites</a>
      </div>
    </div>
    <div class="card">
      <h3>üèÜ {{ leaderboard_title }}</h3>
      <p>See how you rank against other drivers for this sponsor.</p>
      <div class="dashboard-card-actions">
        <a class="btn btn-info" href="{{ url_for('leaderboard.view') }}">View Leaderboard</a>
      </div>
    </div>
    <div class="card">
      <h3>üéØ Sponsor Challenges</h3>
      <p>Take on challenges from your sponsors to earn extra rewards.</p>
      <div class="dashboard-card-actions">
        <button class="btn btn-info" type="button" id="open-driver-challenges">View Challenges</button>
      </div>
    </div>
    <div class="card">
      <h3>üèÖ My Achievements</h3>
      <p>Track your progress and see the milestones you can earn.</p>
      <div class="dashboard-card-actions">
        <button class="btn btn-success" type="button" id="open-driver-achievements">View Achievements</button>
      </div>
    </div>
    <div class="card">
      <h3>üè¢ Sponsor Information</h3>
      <p>View information about your current sponsor and their program details.</p>
      <div class="dashboard-card-actions">
        <a class="btn btn-info" href="{{ url_for('driver.sponsor_information') }}">View Sponsor Info</a>
      </div>
    </div>
    {% endif %}

    {% if role == "sponsor" %}
    <div class="card">
      <h3>üë• Driver Management</h3>
      <p>Review and manage the drivers connected to your organisation.</p>
      <div class="dashboard-card-actions">
        <a class="btn btn-info" href="{{ url_for('sponsor.manage_drivers') }}">Driver Management</a>
      </div>
    </div>
    <div class="card">
      <h3>üõ†Ô∏è Product Management</h3>
      <p>Manage your catalog, filters, and product settings in one place.</p>
      <div class="dashboard-card-actions">
        <a class="btn" href="{{ url_for('sponsor_catalog.index') }}">Manage Products</a>
      </div>
    </div>
    <div class="card">
      <h3>üí≥ Points Settings</h3>
      <p>Configure point rules and budgets across your drivers.</p>
      <div class="dashboard-card-actions">
        <a class="btn btn-info" href="{{ url_for('sponsor.points_settings') }}">Points Settings</a>
      </div>
    </div>
    <div class="card">
      <h3>‚öñÔ∏è Point Disputes</h3>
      <p>Review and resolve disputes submitted by drivers regarding point deductions.</p>
      <div class="dashboard-card-actions">
        <a class="btn btn-warning" href="{{ url_for('sponsor.manage_disputes') }}">Manage Disputes</a>
      </div>
    </div>
    <div class="card">
      <h3>üìà Analytics &amp; Reporting</h3>
      <p>Monitor driver engagement and redemption trends.</p>
      <div class="dashboard-card-actions">
        <a class="btn btn-info" href="{{ url_for('sponsor.sponsor_analytics') }}">Open Analytics &amp; Reporting</a>
      </div>
    </div>
    <div class="card">
      <h3>üßæ Audit Log</h3>
      <p>Review key actions taken by your team.</p>
      <div class="dashboard-card-actions">
        <a class="btn btn-secondary" href="{{ url_for('sponsor.audit_log') }}">View Audit Log</a>
      </div>
    </div>
    <div class="card">
      <h3>üéØ Challenge Management</h3>
      <p>Create and manage sponsor challenges for your drivers.</p>
      <div class="dashboard-card-actions">
        <a class="btn btn-info" href="{{ url_for('sponsor.challenges_manage') }}">Manage Challenges</a>
      </div>
    </div>
    <div class="card">
      <h3>üèÜ Driver Leaderboard</h3>
      <p>Track top-performing drivers across your programs.</p>
      <div class="dashboard-card-actions">
        <a class="btn btn-info" href="{{ url_for('leaderboard.view') }}">View Leaderboard</a>
      </div>
    </div>
    {% endif %}

    {% if role == "admin" %}
    <div class="card">
      <h3>üë• User Management</h3>
      <p>Administer accounts, handle role changes, and access creation, relations, and deactivation tools.</p>
      <div class="dashboard-card-actions">
        <a class="btn btn-primary" href="{{ url_for('admin.manage_users') }}">Open User Management</a>
      </div>
    </div>
    <div class="card">
      <h3>üéüÔ∏è Support Tickets</h3>
      <p>Review, triage, and respond to support requests from drivers and sponsors.</p>
      <div class="dashboard-card-actions">
        <a class="btn btn-info" href="{{ url_for('support_ui.admin_support_hub') }}">Go to Support Tickets</a>
      </div>
    </div>
    <div class="card">
      <h3>üßæ Audit Logs</h3>
      <p>Monitor platform changes and maintain oversight of administrative activity.</p>
      <div class="dashboard-card-actions">
        <a class="btn btn-secondary" href="{{ url_for('admin.audit_log') }}">View Audit Logs</a>
      </div>
    </div>
    <div class="card">
      <h3>üìà Analytics &amp; Reporting</h3>
      <p>Track engagement and performance metrics across the entire ecosystem.</p>
      <div class="dashboard-card-actions">
        <a class="btn" href="{{ url_for('admin.analytics') }}">Open Analytics &amp; Reporting</a>
      </div>
    </div>
    {% endif %}
  </div>
</div>

{% if role == "driver" %}
<div class="challenges-overlay" id="driver-challenges-overlay">
  <div class="challenges-panel">
    <div class="challenges-header">
      <div>
        <h3>Sponsor Challenges</h3>
        <p class="overlay-muted">Challenges from all sponsors you‚Äôre connected with.</p>
      </div>
      <button class="btn btn-secondary" type="button" id="close-driver-challenges">Close</button>
    </div>
    <div class="challenges-body" id="driver-challenges-list">
      <div class="challenges-empty">Loading challenges...</div>
    </div>
  </div>
</div>
<div class="achievements-overlay" id="driver-achievements-overlay">
  <div class="achievements-panel">
    <div class="achievements-header">
      <div>
        <h3>Driver Achievements</h3>
        <p class="overlay-muted">Earn milestones by collecting points and reaching new goals.</p>
      </div>
      <button class="btn btn-secondary" type="button" id="close-driver-achievements">Close</button>
    </div>
    <div class="achievements-body" id="driver-achievements-body">
      <div class="challenges-empty">Loading achievements...</div>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if role == "driver" %}
<script src="{{ url_for('static', filename='js/driver_challenges.js') }}"></script>
<script src="{{ url_for('static', filename='js/driver_achievements.js') }}"></script>
{% endif %}
{% endblock %}
