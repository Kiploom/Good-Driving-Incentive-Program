{% extends "base.html" %}
{% block title %}Reset Password{% endblock %}
{% block body_class %}auth-page{% endblock %}
{% block content %}
<section class="auth-wrap">
  <form method="POST" class="auth-card auth-card--reset">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
  <h1>Reset Password</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <ul class="alert-list">
        {% for category, message in messages %}
          <li class="{{ 'error' if category=='danger' else category }}">{{ message }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}

  <label for="password">New password:</label>
  <input type="password" id="password" name="password" required placeholder="Enter new password">

  <ul class="password-rules">
    <li id="rule-length" class="invalid">❌ At least 8 characters</li>
    <li id="rule-upper" class="invalid">❌ Contains an uppercase letter</li>
    <li id="rule-lower" class="invalid">❌ Contains a lowercase letter</li>
    <li id="rule-number" class="invalid">❌ Contains a number</li>
    <li id="rule-special" class="invalid">❌ Contains a special character (!@#$%^&* etc.)</li>
  </ul>

  <label for="confirm-password">Confirm password:</label>
  <input type="password" id="confirm-password" name="confirm_password" required placeholder="Re-enter new password">
  <p id="confirm-message" class="auth-card__hint invalid">Passwords must match.</p>

  <button type="submit" id="submit-btn" class="auth-submit" disabled>Update Password</button>
  </form>
</section>

<script>
  const passwordField = document.getElementById('password');
  const confirmField = document.getElementById('confirm-password');
  const confirmMessage = document.getElementById('confirm-message');
  const submitBtn = document.getElementById('submit-btn');
  const rules = {
    length: document.getElementById('rule-length'),
    upper: document.getElementById('rule-upper'),
    lower: document.getElementById('rule-lower'),
    number: document.getElementById('rule-number'),
    special: document.getElementById('rule-special'),
  };

  const checkPasswords = () => {
    const val = passwordField.value;
    const confirmation = confirmField.value;

    const tests = {
      length: val.length >= 8,
      upper: /[A-Z]/.test(val),
      lower: /[a-z]/.test(val),
      number: /[0-9]/.test(val),
      special: /[!@#$%^&*(),.?":{}|<>]/.test(val)
    };

    let allValid = true;
    for (const key in tests) {
      const ruleEl = rules[key];
      const requirementText = ruleEl.dataset.requirement || ruleEl.textContent.replace(/^❌ |✅ /, '');
      ruleEl.dataset.requirement = requirementText;
      if (tests[key]) {
        ruleEl.classList.add('valid');
        ruleEl.classList.remove('invalid');
        ruleEl.textContent = '✅ ' + requirementText;
      } else {
        ruleEl.classList.add('invalid');
        ruleEl.classList.remove('valid');
        ruleEl.textContent = '❌ ' + requirementText;
        allValid = false;
      }
    }

    const passwordsMatch = confirmation.length > 0 && val === confirmation;
    confirmMessage.textContent = passwordsMatch ? '✅ Passwords match.' : '❌ Passwords must match.';
    confirmMessage.classList.toggle('valid', passwordsMatch);
    confirmMessage.classList.toggle('invalid', !passwordsMatch);

    submitBtn.disabled = !(allValid && passwordsMatch);
  };

  passwordField.addEventListener('input', checkPasswords);
  confirmField.addEventListener('input', checkPasswords);
  checkPasswords();
</script>
{% endblock %}
