{% extends "base.html" %}

{% block title %}Financial Analytics{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}

{% block content %}
<div class="admin-shell">
  <div class="admin-header">
    <div>
      {% if selected_sponsor %}
        <h1>{{ selected_sponsor.Company }} Financial Analytics</h1>
        <p class="admin-page-description">
          Financial metrics, costs, and ROI insights tailored for {{ selected_sponsor.Company }}. This table displays only purchase and refund transactions with their financial values. New entries are created when drivers make purchases (points deducted) or when orders are refunded or cancelled (points returned). Manual point adjustments and dispute resolutions are not shown in this table. Only actual purchase and refund transactions are displayed; sponsors or drivers without purchase/refund activity will not appear.
        </p>
      {% else %}
        <h1>Financial Analytics</h1>
        <p class="admin-page-description">
          Platform-wide point values, transaction totals, and dollar conversions across all sponsors. This table displays only purchase and refund transactions with their financial values. New entries are created when drivers make purchases (points deducted) or when orders are refunded or cancelled (points returned). Manual point adjustments and dispute resolutions are not shown in this table. Only actual purchase and refund transactions are displayed; sponsors or drivers without purchase/refund activity will not appear.
        </p>
      {% endif %}
    </div>
    <div class="admin-actions">
      <a class="btn btn-secondary" href="{{ url_for('admin.analytics') }}">
        <i class="fas fa-arrow-left"></i>
        <span>Back to Analytics</span>
      </a>
    </div>
  </div>

  <div class="admin-card">
    <form class="admin-form" method="get">
      <div class="form-grid">
        <div>
          <label for="company-filter">Company</label>
          <select id="company-filter" name="company_filter" onchange="this.form.submit()">
            <option value="">All companies</option>
            {% for sponsor_id, sponsor_name in sponsors %}
              <option value="{{ sponsor_name }}" {% if company_filter == sponsor_name %}selected{% endif %}>{{ sponsor_name }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label for="date_from">From Date</label>
          <input type="date" id="date_from" name="date_from" value="{{ date_from or '' }}" onchange="this.form.submit()">
        </div>

        <div>
          <label for="date_to">To Date</label>
          <input type="date" id="date_to" name="date_to" value="{{ date_to or '' }}" onchange="this.form.submit()">
        </div>
      </div>
      <div class="form-actions">
        <button class="btn" type="submit">Apply Filters</button>
        {% if selected_sponsor %}
          <a class="btn btn-secondary" href="{{ url_for('admin.analytics_financial_analytics', company_filter=company_filter) }}">
            Reset Filters
          </a>
        {% else %}
          <a class="btn btn-secondary" href="{{ url_for('admin.analytics_financial_analytics') }}">
            Reset Filters
          </a>
        {% endif %}
        <a class="btn btn-secondary" href="{{ url_for('admin.analytics_financial_analytics_pdf', company_filter=company_filter, date_from=date_from, date_to=date_to) }}" target="_blank">
          <i class="fas fa-file-pdf"></i> Export PDF
        </a>
        <a class="btn btn-secondary" href="{{ url_for('admin.analytics_financial_analytics_csv', company_filter=company_filter, date_from=date_from, date_to=date_to) }}">
          <i class="fas fa-file-csv"></i> Export CSV
        </a>
      </div>
    </form>
  </div>

  <div class="admin-card">
    <h2>Financial Performance Metrics</h2>
    <div class="admin-summary">
      <div class="admin-summary-item">
        <span class="label">Total Transactions</span>
        <span class="value">{{ rows|length }}</span>
      </div>
      <div class="admin-summary-item">
        <span class="label">Companies</span>
        <span class="value">
          {% set unique_companies = rows|map(attribute='0')|map(attribute='Company')|unique|list|length %}
          {{ unique_companies }}
        </span>
      </div>
      <div class="admin-summary-item">
        <span class="label">Total Points</span>
        <span class="value">
          {% set total_points = rows|map(attribute='1.DeltaPoints')|sum %}
          {{ total_points or 0 }}
        </span>
      </div>
      <div class="admin-summary-item">
        <span class="label">Total Dollar Value</span>
        <span class="value">
          {% set total_value = 0 %}
          {% for sponsor, point_change, driver, account in rows %}
            {% if point_change and point_change.DeltaPoints %}
              {% set total_value = total_value + (point_change.DeltaPoints * sponsor.PointToDollarRate) %}
            {% endif %}
          {% endfor %}
          ${{ "%.2f"|format(total_value) }}
        </span>
      </div>
    </div>
  </div>

  <div class="admin-card admin-table-card">
    <header>
      <h2>Financial Transaction Data</h2>
      <p class="admin-muted">Breakdown of purchase and refund transactions, monetary value, and supporting details for each entry. Each row represents a single purchase or refund transaction. New entries are created when drivers make purchases (points deducted) or when orders are refunded or cancelled (points returned). Manual point adjustments and dispute resolutions are not shown in this table. Only actual purchase and refund transactions are displayed.</p>
    </header>
    <div class="table-wrapper">
      <table class="admin-table">
        <thead>
          <tr>
            <th>Company</th>
            <th>Driver Name</th>
            <th>Driver Email</th>
            <th>Points Change</th>
            <th>Point Rate</th>
            <th>Dollar Value</th>
            <th>Reason</th>
            <th>Transaction Date</th>
          </tr>
        </thead>
        <tbody>
          {% for sponsor, point_change, driver, account in rows %}
          <tr>
            <td class="table-strong">{{ sponsor.Company }}</td>
            <td>
              {% if account %}
                {{ account.FirstName }} {{ account.LastName }}
              {% else %}
                <span class="admin-muted">N/A</span>
              {% endif %}
            </td>
            <td>
              {% if account %}
                {{ account.Email }}
              {% else %}
                <span class="admin-muted">N/A</span>
              {% endif %}
            </td>
            <td>
              {% if point_change %}
                <span class="{{ 'admin-points-positive' if point_change.DeltaPoints > 0 else 'admin-points-negative' }}">
                  {{ '+' if point_change.DeltaPoints > 0 else '' }}{{ point_change.DeltaPoints }}
                </span>
              {% else %}
                <span class="admin-muted">N/A</span>
              {% endif %}
            </td>
            <td class="admin-order-number">${{ "%.2f"|format(sponsor.PointToDollarRate) }}</td>
            <td class="admin-order-number">
              {% if point_change and point_change.DeltaPoints %}
                {% set dollar_value = point_change.DeltaPoints * sponsor.PointToDollarRate %}
                <span class="{{ 'admin-points-negative' if dollar_value < 0 else 'admin-points-positive' }}">
                  ${{ "%.2f"|format(dollar_value) }}
                </span>
              {% else %}
                <span class="admin-muted">N/A</span>
              {% endif %}
            </td>
            <td>{{ point_change.Reason if point_change else 'N/A' }}</td>
            <td>{{ point_change.CreatedAt.strftime('%Y-%m-%d %H:%M') if point_change else 'N/A' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="admin-card">
    <h2>Return on Investment Analysis</h2>
    <div class="admin-stat-grid">
      <div class="admin-stat-card">
        <h3>Average Point Rate</h3>
        <p class="value">
          {% set avg_point_rate = 0 %}
          {% set company_count = 0 %}
          {% for sponsor, point_change, driver, account in rows %}
            {% if sponsor.PointToDollarRate %}
              {% set avg_point_rate = avg_point_rate + sponsor.PointToDollarRate %}
              {% set company_count = company_count + 1 %}
            {% endif %}
          {% endfor %}
          {% if company_count > 0 %}
            {% set avg_point_rate = avg_point_rate / company_count %}
            ${{ "%.2f"|format(avg_point_rate) }}
          {% else %}
            $0.00
          {% endif %}
        </p>
      </div>
      <div class="admin-stat-card">
        <h3>Net Points</h3>
        <p class="value">
          {% set total_positive_points = 0 %}
          {% set total_negative_points = 0 %}
          {% for sponsor, point_change, driver, account in rows %}
            {% if point_change %}
              {% if point_change.DeltaPoints > 0 %}
                {% set total_positive_points = total_positive_points + point_change.DeltaPoints %}
              {% else %}
                {% set total_negative_points = total_negative_points + point_change.DeltaPoints %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {{ total_positive_points + total_negative_points }}
        </p>
      </div>
      <div class="admin-stat-card">
        <h3>Net Dollar Value</h3>
        <p class="value">
          {% set total_positive_value = 0 %}
          {% set total_negative_value = 0 %}
          {% for sponsor, point_change, driver, account in rows %}
            {% if point_change and point_change.DeltaPoints %}
              {% set dollar_value = point_change.DeltaPoints * sponsor.PointToDollarRate %}
              {% if dollar_value > 0 %}
                {% set total_positive_value = total_positive_value + dollar_value %}
              {% else %}
                {% set total_negative_value = total_negative_value + dollar_value %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% set net_value = total_positive_value + total_negative_value %}
          <span class="{{ 'admin-points-negative' if net_value < 0 else 'admin-points-positive' }}">
            ${{ "%.2f"|format(net_value) }}
          </span>
        </p>
      </div>
      <div class="admin-stat-card">
        <h3>Avg Points / Transaction</h3>
        <p class="value">
          {% set transaction_count = rows|length %}
          {% if transaction_count > 0 %}
            {{ "%.1f"|format((total_positive_points + total_negative_points) / transaction_count) }}
          {% else %}
            0
          {% endif %}
        </p>
      </div>
    </div>
  </div>

  {% if not rows %}
  <div class="admin-card">
    <div class="admin-empty-state">
      <i class="fas fa-coins"></i>
      <p>No financial analytics data found for the selected filters.</p>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}
