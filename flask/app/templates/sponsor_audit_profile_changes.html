{% extends "base.html" %}
{% block title %}Profile Changes Audit Log{% endblock %}
{% block content %}
<div class="page-shell">
  <div class="page-toolbar">
    <div>
      <h1 class="page-title">{{ sponsor.Company }} Profile Audit Log</h1>
      <p class="page-description">Track updates to your company information, billing details, and enabled features.</p>
    </div>
    <div class="page-toolbar__actions">
      <a class="btn btn-ghost" href="{{ url_for('sponsor.audit_log') }}">Back to Audit Menu</a>
    </div>
  </div>

  <form class="filter-bar" method="get">
    <input type="text" name="q" value="{{ q or '' }}" placeholder="Search field, value, reason…">
    <select name="field_filter" onchange="this.form.submit()">
      <option value="">All fields</option>
      <option value="Company" {% if field_filter=='Company' %}selected{% endif %}>Company</option>
      <option value="BillingEmail" {% if field_filter=='BillingEmail' %}selected{% endif %}>Billing Email</option>
      <option value="BillingStreet" {% if field_filter=='BillingStreet' %}selected{% endif %}>Billing Street</option>
      <option value="BillingCity" {% if field_filter=='BillingCity' %}selected{% endif %}>Billing City</option>
      <option value="BillingState" {% if field_filter=='BillingState' %}selected{% endif %}>Billing State</option>
      <option value="BillingCountry" {% if field_filter=='BillingCountry' %}selected{% endif %}>Billing Country</option>
      <option value="BillingPostal" {% if field_filter=='BillingPostal' %}selected{% endif %}>Billing Postal</option>
      <option value="IsAdmin" {% if field_filter=='IsAdmin' %}selected{% endif %}>Admin Status</option>
      <option value="Features" {% if field_filter=='Features' %}selected{% endif %}>Features</option>
    </select>
    <input type="date" name="date_from" value="{{ date_from or '' }}" placeholder="From date" onchange="this.form.submit()" title="From Date">
    <input type="date" name="date_to" value="{{ date_to or '' }}" placeholder="To date" onchange="this.form.submit()" title="To Date">
    <select name="sort" onchange="this.form.submit()">
      <option value="desc" {% if sort_order=='desc' %}selected{% endif %}>Most Recent</option>
      <option value="asc" {% if sort_order=='asc' %}selected{% endif %}>Least Recent</option>
    </select>
    <div class="filter-actions">
      <button class="btn btn-secondary" type="submit">Apply Filters</button>
      <a href="{{ url_for('sponsor.sponsor_audit_profile_changes') }}" class="btn btn-ghost">Reset</a>
    </div>
  </form>

  <div class="card table-card">
    <table>
      <thead>
        <tr>
          <th>Changed At</th>
          <th>Field</th>
          <th>Old Value</th>
          <th>New Value</th>
          <th>Changed By</th>
          <th>Reason</th>
        </tr>
      </thead>
      <tbody>
        {% for audit, sponsor_obj, sponsor_account, changed_by_account in rows %}
        <tr>
          <td class="text-muted">
            {{ audit.ChangedAt.strftime('%Y-%m-%d %H:%M') }}
          </td>
          <td>
            <span class="table-strong">{{ audit.FieldName }}</span>
          </td>
          <td>
            {% if audit.OldValue %}
              <span class="mono-chip mono-chip--old">{{ audit.OldValue }}</span>
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </td>
          <td>
            {% if audit.NewValue %}
              <span class="mono-chip mono-chip--new">{{ audit.NewValue }}</span>
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </td>
          <td>
            {% if changed_by_account %}
              <div class="table-strong">{{ changed_by_account.FirstName }} {{ changed_by_account.LastName }}</div>
              <div class="table-meta">{{ changed_by_account.Email }}</div>
            {% else %}
              <span class="text-muted">Self-Update</span>
            {% endif %}
          </td>
          <td>
            {% if audit.ChangeReason %}
              <em class="text-muted">{{ audit.ChangeReason }}</em>
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if not rows %}
  <div class="card">
    <p class="table-empty text-center">No profile changes found for the selected filters.</p>
  </div>
  {% endif %}
</div>
{% endblock %}
