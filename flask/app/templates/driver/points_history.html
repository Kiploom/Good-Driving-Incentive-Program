{% extends "base.html" %}
{% block title %}My Points History{% endblock %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/points-history.css') }}">
{% endblock %}

{% block content %}
<section class="points-history">
  <div class="points-history-header">
    <h1>My Points History</h1>

    {% if driver %}
      <div class="card balance-card">
        <div class="balance-card__row">
          <span class="balance-card__label">Current Balance</span>
          <span class="balance-card__value">{{ env_points_balance }} pts</span>
        </div>

        <div class="balance-card__meta">
          {% if sponsor_rate %}
            <div>
              <em>Conversion rate:</em>
              <strong>1 point = ${{ "%.2f"|format(sponsor_rate) }}</strong>
            </div>
            <div>
              ≈ <strong>${{ "%.2f"|format(env_points_balance * sponsor_rate) }}</strong> total value
            </div>
          {% else %}
            <div class="muted">
              Sponsor conversion rate unavailable
            </div>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>

  {% if driver %}
  <div class="goal-card card">
    <form method="post" action="{{ url_for('driver.save_points_goal') }}" class="goal-card__form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="goal-card__header">
        <div>
          <h3>Reward Goal</h3>
          {% if goal %}
            <p>{{ goal.name or 'Unnamed reward' }}{% if goal.points %} • {{ goal.points }} pts{% endif %}</p>
          {% else %}
            <p>Set a target reward and we’ll track how close you are.</p>
          {% endif %}
        </div>
        {% if goal and goal.points %}
        <div class="goal-card__summary">
          <div>{{ env_points_balance }} / {{ goal.points }} pts</div>
          {% if goal.remaining is not none %}
            <div>{{ goal.remaining }} pts to go</div>
          {% endif %}
        </div>
        {% endif %}
      </div>

      {% if goal and goal.points %}
      <div class="goal-progress" aria-label="Progress toward goal">
        <div class="goal-progress-bar" style="width: {{ goal.progress_pct or 0 }}%;"></div>
      </div>
      <div class="goal-progress-meta">
        {% if goal.achieved %}
          <span class="pill pill--success">Goal reached—enjoy your reward!</span>
        {% else %}
          <span>{{ goal.remaining }} pts remaining</span>
        {% endif %}
        <span>{{ goal.progress_pct or 0 }}% complete</span>
      </div>
      {% endif %}

      <div class="goal-form-grid">
        <label>
          Reward name
          <input type="text" name="target_name" value="{{ goal.name if goal else '' }}" placeholder="e.g., Noise-cancelling headphones">
        </label>
        <label>
          Target points
          <input type="number" min="1" name="target_points" value="{{ goal.points if goal and goal.points else '' }}" placeholder="Points needed">
        </label>
      </div>

      <div class="goal-actions">
        <button type="submit" class="btn btn-info goal-save-btn">Save Goal</button>
        <button type="submit" name="clear_goal" value="1" class="btn btn-secondary goal-clear-btn" onclick="return confirm('Clear your reward goal?');">Clear Goal</button>
      </div>
    </form>
  </div>

  <div class="points-export">
    <a class="btn" href="{{ url_for('driver.points_history_export', start_date=filters.start_date, end_date=filters.end_date, reason=filters.reason, reason_exact=filters.reason_exact, txn_type=filters.txn_type) }}">
      <span class="fas fa-file-pdf" aria-hidden="true"></span>
      Export point history (PDF)
    </a>
  </div>
  {% endif %}

  <form method="get" class="card points-history-filters">
    <div class="filters-grid">
      <div>
        <label for="filter-start-date">Start Date</label>
        <input id="filter-start-date" type="date" name="start_date" value="{{ filters.start_date }}">
      </div>

      <div>
        <label for="filter-end-date">End Date</label>
        <input id="filter-end-date" type="date" name="end_date" value="{{ filters.end_date }}">
      </div>

      <div>
        <label for="filter-reason">Reason</label>
        <input id="filter-reason"
               type="text"
               name="reason"
               placeholder="Search reason..."
               value="{{ filters.reason }}">
      </div>

      <div>
        <label for="filter-reason-exact">Reason is</label>
        <select id="filter-reason-exact" name="reason_exact">
          <option value="">All reasons</option>
          {% for reason in available_reasons %}
            <option value="{{ reason }}" {% if filters.reason_exact == reason %}selected{% endif %}>{{ reason }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label for="filter-txn-type">Type</label>
        <select id="filter-txn-type" name="txn_type">
          <option value="all" {% if filters.txn_type == 'all' %}selected{% endif %}>All</option>
          <option value="positive" {% if filters.txn_type == 'positive' %}selected{% endif %}>Positive</option>
          <option value="negative" {% if filters.txn_type == 'negative' %}selected{% endif %}>Negative</option>
        </select>
      </div>
    </div>

    <div class="filters-actions">
      <button type="submit" class="btn">
        Apply Filters
      </button>

      {% if filters.start_date or filters.end_date or filters.reason or filters.reason_exact or filters.txn_type != 'all' %}
        <a href="{{ url_for('driver.points_history') }}" class="btn btn-secondary">
          Clear
        </a>
      {% endif %}
    </div>
  </form>

  {% set current_driver_id  = session.get('driver_id') %}
  {% set current_sponsor_id = session.get('sponsor_id') %}

  {% set ns = namespace(company=(current_company if current_company is defined else None)) %}
  {% if not ns.company and transactions and current_sponsor_id %}
    {% for t in transactions %}
      {% if t.SponsorID == current_sponsor_id and t.sponsor and t.sponsor.Company %}
        {% set ns.company = t.sponsor.Company %}
      {% endif %}
    {% endfor %}
  {% endif %}

  {% if not current_driver_id or not current_sponsor_id %}
    <div class="empty-state">
      No sponsor environment is selected. Choose an environment to see point history.
    </div>
  {% elif not ns.company %}
    <div class="empty-state">
      Unable to determine your current company from the selected environment. Please try switching environments again.
    </div>
  {% else %}
    {% set shown = namespace(count=0) %}

    {% if transactions %}
      <div class="card points-history-table">
        <table>
          <thead>
            <tr>
              <th scope="col">Date</th>
              <th scope="col">Change</th>
              <th scope="col">Source</th>
              <th scope="col">Balance After</th>
              <th scope="col">Reason</th>
              <th scope="col">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for t in transactions %}
              {% if t.DriverID == current_driver_id and t.sponsor and t.sponsor.Company == ns.company %}
                {% set shown.count = shown.count + 1 %}
                {% set change_class = 'positive' if t.DeltaPoints > 0 else ('negative' if t.DeltaPoints < 0 else 'neutral') %}
                <tr>
                  <td>{{ t.CreatedAt.strftime('%Y-%m-%d %H:%M') if t.CreatedAt else '—' }}</td>
                  <td>
                    <span class="points-change {{ change_class }}">
                      {% if t.DeltaPoints > 0 %}+{% endif %}{{ t.DeltaPoints }}
                    </span>
                  </td>
                  <td>
                    {% set actor_label = t.actor_display_label %}
                    {% set impersonation_hint = t.impersonation_hint %}
                    {% set impersonation_class = 'impersonated' if t.impersonation_label else '' %}
                    <span class="actor-label {{ impersonation_class }}" {% if impersonation_hint %}title="{{ impersonation_hint }}"{% endif %}>
                      {{ actor_label }}
                    </span>
                  </td>
                  <td>{{ t.BalanceAfter }}</td>
                  <td>{{ t.Reason or '—' }}</td>
                  <td>
                    {% set has_dispute = t._has_dispute if t._has_dispute is defined else False %}
                    {% set dispute_status = t._latest_dispute_status if t._latest_dispute_status is defined else None %}
                    
                    {# If helper properties not set, check manually #}
                    {% if not has_dispute %}
                      {% set dispute_count = 0 %}
                      {% if t._disputes_list is defined and t._disputes_list %}
                        {% set dispute_count = t._disputes_list|length %}
                      {% elif t.disputes %}
                        {% for d in t.disputes %}
                          {% set dispute_count = dispute_count + 1 %}
                        {% endfor %}
                      {% endif %}
                      {% if dispute_count > 0 %}
                        {% set has_dispute = True %}
                        {# Get status from first dispute #}
                        {% if t._disputes_list is defined and t._disputes_list and t._disputes_list|length > 0 %}
                          {% set dispute_status = t._disputes_list[0].Status|lower if t._disputes_list[0].Status else None %}
                        {% elif t.disputes %}
                          {% for d in t.disputes %}
                            {% if not dispute_status %}
                              {% set dispute_status = d.Status|lower if d.Status else None %}
                            {% endif %}
                          {% endfor %}
                        {% endif %}
                      {% endif %}
                    {% endif %}
                    
                    {# Show status badge if dispute exists, otherwise show button (only for negative changes) #}
                    {% if has_dispute %}
                      {% if dispute_status == 'pending' %}
                        <span class="badge bg-warning text-dark">Dispute Pending</span>
                        <br><small class="text-muted">Awaiting sponsor review</small>
                      {% elif dispute_status == 'approved' %}
                        <span class="badge bg-success">Dispute Approved</span>
                        <br><small class="text-muted">Points restored</small>
                      {% elif dispute_status == 'denied' %}
                        <span class="badge bg-secondary">Dispute Denied</span>
                        <br><small class="text-muted">Cannot dispute again</small>
                      {% else %}
                        <span class="badge bg-secondary">Dispute Resolved</span>
                        <br><small class="text-muted">Cannot dispute again</small>
                      {% endif %}
                      {# Show disabled button as visual indicator #}
                      <button type="button" class="btn btn-sm btn-outline-secondary" disabled style="margin-top: 4px; cursor: not-allowed; opacity: 0.5;">
                        <i class="fas fa-exclamation-triangle"></i> Dispute
                      </button>
                    {% elif t.DeltaPoints < 0 %}
                      <button type="button" class="btn btn-sm btn-outline-danger dispute-btn" 
                              data-point-change-id="{{ t.PointChangeID }}"
                              data-date="{{ t.CreatedAt.strftime('%Y-%m-%d %H:%M') if t.CreatedAt else '—' }}"
                              data-points="{{ t.DeltaPoints }}"
                              data-balance="{{ t.BalanceAfter }}"
                              data-reason="{{ t.Reason or 'No reason provided' }}"
                              data-submit-url="{{ url_for('driver.submit_point_dispute', point_change_id=t.PointChangeID) }}"
                              title="Dispute this point deduction">
                        <i class="fas fa-exclamation-triangle"></i> Dispute
                      </button>
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                </tr>
              {% endif %}
            {% endfor %}
            {% if shown.count == 0 %}
              <tr>
                <td colspan="6">
                  No point transactions found for your current company's environments and filters.
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="empty-state">
        No point transactions found for the selected filters.
      </div>
    {% endif %}
  {% endif %}
</section>

<!-- Single Reusable Dispute Modal (only shown for transactions without existing disputes) -->
<div class="modal fade" id="disputeModal" tabindex="-1" aria-labelledby="disputeModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="disputeModalLabel">Dispute Point Deduction</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" id="disputeForm" action="">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-body">
          <div class="mb-3">
            <p><strong>Transaction Details:</strong></p>
            <ul id="disputeTransactionDetails">
              <!-- Populated by JavaScript -->
            </ul>
          </div>
          <div class="mb-3">
            <label for="disputeReason" class="form-label">Why are you disputing this deduction? <span class="text-danger">*</span></label>
            <textarea class="form-control" id="disputeReason" name="driver_reason" rows="4" required placeholder="Please explain why you believe this point deduction is incorrect..."></textarea>
            <small class="form-text text-muted">Your explanation will be reviewed by your sponsor.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Submit Dispute</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const disputeModal = new bootstrap.Modal(document.getElementById('disputeModal'));
  const disputeForm = document.getElementById('disputeForm');
  const disputeTransactionDetails = document.getElementById('disputeTransactionDetails');
  const disputeReason = document.getElementById('disputeReason');
  
  // Handle dispute button clicks - only for enabled buttons
  document.querySelectorAll('.dispute-btn:not(:disabled)').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      // Double-check that this transaction doesn't already have a dispute
      // (in case the page state changed)
      const pointChangeId = this.getAttribute('data-point-change-id');
      const row = this.closest('tr');
      
      // Check if there's already a dispute badge in this row
      const existingBadge = row.querySelector('.badge');
      const disabledButton = row.querySelector('button[disabled]');
      
      if (existingBadge && (existingBadge.textContent.includes('Pending') || 
                            existingBadge.textContent.includes('Approved') || 
                            existingBadge.textContent.includes('Denied') ||
                            existingBadge.textContent.includes('Resolved'))) {
        e.preventDefault();
        e.stopPropagation();
        alert('This transaction has already been disputed. Please refresh the page to see the current status.');
        return false;
      }
      
      if (disabledButton) {
        e.preventDefault();
        e.stopPropagation();
        alert('This transaction has already been disputed and cannot be disputed again.');
        return false;
      }
      
      const date = this.getAttribute('data-date');
      const points = this.getAttribute('data-points');
      const balance = this.getAttribute('data-balance');
      const reason = this.getAttribute('data-reason');
      const submitUrl = this.getAttribute('data-submit-url');
      
      // Populate transaction details
      disputeTransactionDetails.innerHTML = `
        <li>Date: ${date}</li>
        <li>Points Deducted: ${points}</li>
        <li>Balance After: ${balance}</li>
        <li>Reason: ${reason}</li>
      `;
      
      // Set form action
      disputeForm.action = submitUrl;
      
      // Clear previous reason
      disputeReason.value = '';
      
      // Show modal
      disputeModal.show();
    });
  });
  
  // Reset form when modal is hidden
  document.getElementById('disputeModal').addEventListener('hidden.bs.modal', function() {
    disputeReason.value = '';
    disputeTransactionDetails.innerHTML = '';
  });
});
</script>
{% endblock %}
