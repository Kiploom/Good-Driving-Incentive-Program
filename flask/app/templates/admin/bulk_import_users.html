{% extends "base.html" %}
{% block title %}Bulk Import Accounts{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/settings.css') }}">
{% endblock %}

{% block content %}
<div class="settings-page">
  <div class="settings-container">
    <header class="settings-header">
      <div class="settings-header-icon">
        <i class="fas fa-file-upload" aria-hidden="true"></i>
      </div>
      <div class="settings-header-content">
        <h1>Bulk Import Accounts</h1>
        <p>
          Upload a pipe-delimited .txt or .csv file to create sponsor companies, sponsor admins, and drivers in a single batch.
        </p>
      </div>
      <div class="settings-header-actions">
        <a href="{{ url_for('admin.manage_users') }}" class="btn btn-secondary">
          <i class="fas fa-arrow-left" aria-hidden="true"></i>
          Back to User Management
        </a>
      </div>
    </header>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
      <div class="settings-card">
        {% for category, message in messages %}
        <div class="alert alert-{{ 'danger' if category == 'error' else category }}" role="alert">{{ message }}</div>
        {% endfor %}
      </div>
      {% endif %}
    {% endwith %}

    <section class="settings-card">
      <div class="settings-section">
        <div class="settings-section-header">
          <i class="fas fa-cloud-upload-alt" aria-hidden="true"></i>
          <h2>Upload Your Pipe File</h2>
        </div>
        <p class="settings-section-description">
          Accounts created from this upload can span multiple organizations. Include organization rows before user rows to ensure all relationships are created.
        </p>

        <div class="settings-callout info">
          <i class="fas fa-info-circle" aria-hidden="true"></i>
          <div>
            Each imported user starts with the temporary password <code>TempPassword123!</code>. Most spreadsheet tools can export pipe-delimited files by choosing “Text (Pipe delimited)” or saving as <code>.txt</code> or <code>.csv</code> with pipe delimiters (<code>|</code>).
          </div>
        </div>

        <form method="POST" enctype="multipart/form-data">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <input type="hidden" name="action" value="bulk_import" />

          <div class="inline-form">
            <div class="form-control">
              <label for="csv_file">Select pipe-delimited .txt or .csv file</label>
              <input type="file" id="csv_file" name="csv_file" accept=".txt,.csv" required />
            </div>
          </div>

          <div class="settings-actions">
            <button class="btn btn-primary" type="submit">
              <i class="fas fa-file-import" aria-hidden="true"></i>
              Upload and Import
            </button>
          </div>
        </form>
      </div>
    </section>

    <section class="settings-card">
      <div class="settings-section">
        <div class="settings-section-header">
          <i class="fas fa-table" aria-hidden="true"></i>
          <h2>Text File Format Guide</h2>
        </div>
        <p class="settings-section-description">
          Structure the file exactly as shown below. Use the pipe character (<code>|</code>) as the delimiter and add one organization row for every sponsor company you reference.
        </p>

        <div class="settings-callout warning">
          <i class="fas fa-exclamation-circle" aria-hidden="true"></i>
          <div>
            <strong>Tip:</strong> Organization rows are optional for existing companies. If the company already exists, the row will be skipped automatically without failing the import.
          </div>
        </div>

        <h3>Record types</h3>
        <ul>
          <li><strong>O</strong> — Sponsor company (organization)</li>
          <li><strong>S</strong> — Sponsor user account</li>
          <li><strong>D</strong> — Driver account</li>
        </ul>

        <h3>Expected column order</h3>
        <p><strong>Organization rows (O)</strong> require two columns: <code>O|Company Name</code>.</p>
        <p><strong>User rows (S or D)</strong> require five columns in the following order:</p>
        <ul>
          <li><strong>Column 1:</strong> Record code (<code>S</code> or <code>D</code>)</li>
          <li><strong>Column 2:</strong> Organization / company name</li>
          <li><strong>Column 3:</strong> First name</li>
          <li><strong>Column 4:</strong> Last name</li>
          <li><strong>Column 5:</strong> Email address</li>
        </ul>

        <h3>Example rows</h3>
        <pre class="settings-code-block">O|ACME Logistics
O|Northwind Transport
S|ACME Logistics|Avery|Stone|avery.stone@acme.com
D|ACME Logistics|Jordan|Nguyen|jordan.nguyen@acme.com
D|Northwind Transport|Riley|Chen|riley.chen@northwind.com</pre>

        <h3>Import tips</h3>
        <ul>
          <li>Save the file with a <code>.txt</code> extension; <code>.csv</code> is also accepted as long as it uses pipe delimiters.</li>
          <li>Duplicate companies or email addresses are skipped and logged automatically.</li>
          <li>Accounts start in <em>Active</em> status and receive verification emails where applicable.</li>
          <li>Large files may take time to process; stay on the page until you see a confirmation message.</li>
        </ul>
      </div>
    </section>

    <section class="settings-card settings-card--nested">
      <div class="settings-section">
        <div class="settings-section-header">
          <i class="fas fa-clipboard-check" aria-hidden="true"></i>
          <h2>Review Your Import</h2>
        </div>
        <p class="settings-section-description">
          Need to audit past uploads or troubleshoot a failed row? Open the bulk import log for history and detailed errors.
        </p>
        <div class="settings-actions">
          <a class="btn btn-secondary" href="{{ url_for('admin.bulk_import_audit_log') }}">
            <i class="fas fa-list" aria-hidden="true"></i>
            View Bulk Import Logs
          </a>
        </div>
      </div>
    </section>
  </div>
</div>
{% endblock %}
