{% extends "base.html" %}
{% block title %}User Management{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}

{% block content %}
<div class="admin-shell">
  <div class="admin-header">
    <div>
      <h1>User Management</h1>
      <p>Search, review, and administer every account across the platform. Update statuses instantly or drill into account details with a single click.</p>
    </div>
  </div>

  <div class="admin-card">
    <h2><i class="fas fa-bolt"></i> User Operations</h2>
    <p>Jump into the high-impact workflows for onboarding, maintaining, and triaging user accounts.</p>
    <div class="admin-tile-group">
      <div class="admin-tile">
        <span class="icon"><i class="fas fa-user-plus"></i></span>
        <h3>Create Accounts</h3>
        <p>Create new driver, sponsor, or admin accounts individually and send welcome credentials.</p>
        <a href="{{ url_for('admin.account_management') }}" class="btn btn-primary">
          <i class="fas fa-arrow-right"></i>
          Open Creator
        </a>
      </div>
      <div class="admin-tile">
        <span class="icon"><i class="fas fa-people-arrows"></i></span>
        <h3>Driver-Sponsor Relations</h3>
        <p>Review and adjust driver assignments across sponsor companies, or resolve edge cases.</p>
        <a href="{{ url_for('admin.manage_driver_sponsor_relations') }}" class="btn btn-secondary">
          <i class="fas fa-arrow-right"></i>
          Manage Relations
        </a>
      </div>
      <div class="admin-tile">
        <span class="icon"><i class="fas fa-user-slash"></i></span>
        <h3>Deactivation Requests</h3>
        <p>Approve or decline account shutdown requests submitted by sponsors or drivers.</p>
        <a href="{{ url_for('account_deactivation.admin_list') }}" class="btn btn-secondary">
          <i class="fas fa-arrow-right"></i>
          Review Queue
        </a>
      </div>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="admin-banner {% if category == 'error' %}admin-banner--error{% elif category == 'success' %}admin-banner--success{% else %}admin-banner--info{% endif %}">
          <i class="fas {% if category == 'error' %}fa-circle-exclamation{% elif category == 'success' %}fa-check-circle{% else %}fa-circle-info{% endif %}"></i>
          <div>{{ message }}</div>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="admin-card">
    <h2><i class="fas fa-filter"></i> Filters</h2>
    <form method="GET" class="admin-form">
      <div class="form-grid">
        <div>
          <label for="search">Search</label>
          <input type="text" id="search" name="search" placeholder="Email, username, or name" value="{{ search_query }}">
        </div>
        <div>
          <label>Status</label>
          <div class="admin-chip-group">
            <a href="{{ url_for('admin.manage_users') }}" class="admin-chip {% if not status_filter %}active{% endif %}">
              <i class="fas fa-layer-group"></i>
              <span>All ({{ total_users }})</span>
            </a>
            <a href="{{ url_for('admin.manage_users', status='A') }}" class="admin-chip {% if status_filter == 'A' %}active{% endif %}">
              <i class="fas fa-check-circle"></i>
              <span>Active ({{ active_users }})</span>
            </a>
            <a href="{{ url_for('admin.manage_users', status='I') }}" class="admin-chip {% if status_filter == 'I' %}active{% endif %}">
              <i class="fas fa-pause-circle"></i>
              <span>Inactive ({{ inactive_users }})</span>
            </a>
            <a href="{{ url_for('admin.manage_users', status='H') }}" class="admin-chip {% if status_filter == 'H' %}active{% endif %}">
              <i class="fas fa-archive"></i>
              <span>Archived ({{ archived_users }})</span>
            </a>
            <a href="{{ url_for('admin.manage_users', status='P') }}" class="admin-chip {% if status_filter == 'P' %}active{% endif %}">
              <i class="fas fa-hourglass-start"></i>
              <span>Pending ({{ pending_users }})</span>
            </a>
          </div>
        </div>
      </div>
      {% if status_filter %}
        <input type="hidden" name="status" value="{{ status_filter }}">
      {% endif %}
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-search"></i>
          <span>Apply Filters</span>
        </button>
        <a href="{{ url_for('admin.manage_users') }}" class="btn btn-secondary">
          <i class="fas fa-undo"></i>
          <span>Clear</span>
        </a>
      </div>
    </form>
  </div>

  <div class="admin-card" aria-live="polite">
    <div class="admin-floating-actions">
      <h2><i class="fas fa-user-shield"></i> Role Permissions</h2>
      <span class="admin-meta">Live reference of entitlements for each account type.</span>
    </div>
    <div id="permissions-container" class="admin-permissions">Loading permissions...</div>
  </div>

  <div class="admin-card admin-table-card users-card">
    <header>
      <div class="admin-floating-actions">
        <h2><i class="fas fa-users"></i> Directory</h2>
        <span class="admin-meta">Showing {{ accounts|length }} of {{ total_users }} accounts</span>
      </div>
    </header>
    <div class="table-wrapper">
      <table class="table">
        <thead>
          <tr>
            <th>Email / Username</th>
            <th>Name</th>
            <th>Type</th>
            <th>Status</th>
            <th>Created</th>
            <th class="text-right">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for account in accounts %}
          <tr>
            <td>
              <div class="user-row">
                {% set avatar_url = get_avatar_display_url(account.ProfileImageURL) %}
                <img src="{{ avatar_url }}" alt="Avatar for {{ account.Email }}" class="user-avatar">
                <div>
                  <div class="user-primary">{{ account.Email }}</div>
                  <div class="user-secondary">@{{ account.Username }}</div>
                </div>
              </div>
            </td>
            <td>{{ account.FirstName or 'N/A' }} {{ account.LastName or '' }}</td>
            <td>
              <span class="badge-type">{{ account.AccountType }}</span>
              {% if account.RoleSpecificInfo %}
                <div class="user-secondary">{{ account.RoleSpecificInfo }}</div>
              {% endif %}
            </td>
            <td>
              <form method="POST" action="{{ url_for('admin.change_user_status', account_id=account.AccountID) }}" class="status-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <select name="status" class="admin-status-select">
                  <option value="A" {% if account.Status.upper() == 'A' %}selected{% endif %}>Active</option>
                  <option value="I" {% if account.Status.upper() == 'I' %}selected{% endif %}>Inactive</option>
                  <option value="H" {% if account.Status.upper() == 'H' %}selected{% endif %}>Archived</option>
                </select>
                <button type="submit" class="btn btn-secondary btn-sm">Update</button>
              </form>
            </td>
            <td>
              {% if account.CreatedAt %}
                {{ account.CreatedAt.strftime('%Y-%m-%d') }}
              {% else %}
                <span class="admin-muted">N/A</span>
              {% endif %}
            </td>
            <td class="text-right">
              <div class="user-actions">
                <button class="btn btn-secondary btn-sm" onclick="openUserModal('{{ account.AccountID }}')">
                  <i class="fas fa-eye"></i>
                  <span>View</span>
                </button>
                <button class="btn btn-warning btn-sm" onclick="confirmImpersonate(event, '{{ account.AccountID }}', '{{ account.Email }}', '{{ account.FirstName }} {{ account.LastName }}')">
                  <i class="fas fa-user-secret"></i>
                  <span>Impersonate</span>
                </button>
              </div>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="6">
              <div class="admin-empty-state">
                <i class="fas fa-user-slash"></i>
                <p>No users found for your filters.</p>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="table-footer">
      <span class="admin-muted">Page {{ pagination.page }} of {{ pagination.pages }}</span>
      <div class="pager-btns">
        {% if pagination.has_prev %}
          <a class="btn btn-secondary" href="{{ url_for('admin.manage_users', page=pagination.prev_num, status=status_filter, account_type=account_type_filter, search=search_query) }}">
            <i class="fas fa-arrow-left"></i>
            <span>Previous</span>
          </a>
        {% endif %}
        {% if pagination.has_next %}
          <a class="btn btn-primary" href="{{ url_for('admin.manage_users', page=pagination.next_num, status=status_filter, account_type=account_type_filter, search=search_query) }}">
            <span>Next</span>
            <i class="fas fa-arrow-right"></i>
          </a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div id="userModalBackdrop" class="admin-modal-backdrop" onclick="closeUserModal(event)">
  <div class="admin-modal" role="dialog" aria-modal="true" aria-labelledby="userModalTitle" onclick="event.stopPropagation()">
    <div class="admin-modal-header">
      <h3 id="userModalTitle"><i class="fas fa-user"></i> User Details</h3>
      <button class="btn btn-secondary btn-sm" onclick="closeUserModal(event)">Close</button>
    </div>
    <div class="admin-modal-body" id="userModalContent">Loading...</div>
    <div class="admin-modal-footer">
      <button class="btn btn-secondary" onclick="closeUserModal(event)">Close</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Permissions fetch and render
async function loadPermissions() {
  const el = document.getElementById('permissions-container');
  try {
    const res = await fetch('{{ url_for('admin.get_permissions') }}', { credentials: 'same-origin' });
    if (!res.ok) throw new Error('Failed to load permissions');
    const data = await res.json();
    const roles = data.roles || {};
    el.innerHTML = '';
    Object.keys(roles).forEach(role => {
      const group = document.createElement('div');
      group.className = 'admin-permission-group';
      const title = document.createElement('div');
      title.className = 'role-title';
      title.textContent = role;
      group.appendChild(title);
      const perms = roles[role] || [];
      if (perms.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'admin-muted';
        empty.textContent = 'No permissions defined';
        group.appendChild(empty);
      } else {
        perms.forEach(p => {
          const chip = document.createElement('span');
          chip.className = 'badge';
          chip.textContent = p;
          group.appendChild(chip);
        });
      }
      el.appendChild(group);
    });
  } catch (e) {
    el.textContent = 'Failed to load permissions';
  }
}

// Modal logic
function openUserModal(accountId) {
  const backdrop = document.getElementById('userModalBackdrop');
  const content = document.getElementById('userModalContent');
  backdrop.classList.add('open');
  content.textContent = 'Loading...';
  fetch(`{{ url_for('admin.get_user_details', account_id='__ID__') }}`.replace('__ID__', accountId), { credentials: 'same-origin' })
    .then(r => r.json())
    .then(data => {
      if (data.error) { content.textContent = data.error; return; }
      content.innerHTML = `
        <div class="modal-grid">
          <div><strong>Email</strong></div><div>${escapeHtml(data.Email || '')}</div>
          <div><strong>Username</strong></div><div>${escapeHtml(data.Username || '')}</div>
          <div><strong>Role</strong></div><div><span class="badge">${escapeHtml(data.AccountType || '')}</span></div>
          <div><strong>Status</strong></div><div>${escapeHtml(data.Status || '')}</div>
          <div><strong>First Name</strong></div><div>${escapeHtml(data.FirstName || '')}</div>
          <div><strong>Last Name</strong></div><div>${escapeHtml(data.LastName || '')}</div>
          <div><strong>Created</strong></div><div>${escapeHtml((data.CreatedAt || '').replace('T',' ').slice(0,19))}</div>
          <div><strong>Linked Accounts</strong></div><div>${formatLinked(data.Linked)}</div>
        </div>
      `;
    })
    .catch(() => { content.textContent = 'Failed to load user details'; });
}
function closeUserModal(event) {
  const backdrop = document.getElementById('userModalBackdrop');
  backdrop.classList.remove('open');
}
function formatLinked(linked) {
  if (!linked || Object.keys(linked).length === 0) {
    return '<span class="admin-muted">None</span>';
  }
  const friendlyMap = {
    DriverID: 'Driver profile connected',
    SponsorID: 'Sponsor profile connected',
    AdminID: 'Admin profile connected'
  };
  const humanizeKey = (key) => {
    return key
      .replace(/ID$/i, '')
      .replace(/([A-Z])/g, ' $1')
      .replace(/\s+/g, ' ')
      .trim();
  };
  const entries = [];
  Object.entries(linked).forEach(([key, value]) => {
    if (friendlyMap[key]) {
      entries.push(friendlyMap[key]);
      return;
    }
    const valueStr = value != null ? String(value) : '';
    if (valueStr && key.toLowerCase().includes('id')) {
      const label = humanizeKey(key) || 'Linked record';
      entries.push(`${label} linked`);
      return;
    }
    if (valueStr) {
      entries.push(`${key}: ${valueStr}`);
    }
  });
  if (!entries.length) {
    return '<span class="admin-muted">None</span>';
  }
  return entries
    .map(text => `<span class="badge">${escapeHtml(text)}</span>`)
    .join(' ');
}
function escapeHtml(str) {
  return String(str).replace(/[&<>"']/g, function(m) {
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]);
  });
}

// Impersonation confirmation and execution
function confirmImpersonate(event, accountId, email, name) {
  const message = `Are you sure you want to impersonate ${name || email}?\n\nYou will be logged in as this user and have access to all their capabilities. Click OK to continue or Cancel to abort.`;
  if (confirm(message)) {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Impersonating...';
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    if (!csrfToken) {
      alert('CSRF token not found. Please refresh the page and try again.');
      btn.disabled = false;
      btn.innerHTML = originalText;
      return;
    }
    const formData = new FormData();
    formData.append('csrf_token', csrfToken);
    fetch(`{{ url_for('admin.impersonate_user', account_id='__ID__') }}`.replace('__ID__', accountId), {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken
      },
      credentials: 'same-origin',
      body: formData
    })
    .then(async response => {
      let data;
      try {
        data = await response.json();
      } catch (err) {
        data = { error: 'An unexpected error occurred while attempting to impersonate.' };
      }
      if (response.ok) {
        const redirectUrl = data.redirect_url || data.redirect;
        if (redirectUrl) {
          window.location.href = redirectUrl;
          return;
        }
        if (data.success) {
          window.location.href = '{{ url_for("dashboard") }}';
          return;
        }
      }
      if (data.error) throw new Error(data.error);
      throw new Error('Unable to impersonate user.');
    })
    .catch(err => {
      alert(err.message || 'Unable to impersonate user.');
      btn.disabled = false;
      btn.innerHTML = originalText;
    });
  }
}

window.addEventListener('DOMContentLoaded', () => {
  loadPermissions();
});
</script>
{% endblock %}

