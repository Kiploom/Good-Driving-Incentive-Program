{% extends "base.html" %}

{% block title %}Invoice Log{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}

{% block content %}
<div class="admin-shell">
  <div class="admin-header">
    <div>
      <h1>Invoice Log</h1>
      <p>View the most recent invoice generated for each sponsor and billing month.</p>
    </div>
    <div class="admin-actions">
      <a class="btn btn-secondary" href="{{ url_for('admin.analytics', company_filter=company_filter) }}">
        <i class="fas fa-arrow-left"></i>
        <span>Back to Analytics</span>
      </a>
      <a class="btn btn-primary" href="{{ url_for('admin.analytics_invoices', company_filter=company_filter) }}">
        <i class="fas fa-file-invoice"></i>
        <span>Open Invoice Center</span>
      </a>
    </div>
  </div>

  <div class="admin-card">
    <form class="admin-form" method="get">
      <div class="form-grid">
        <div>
          <label for="company-filter">Filter by Company</label>
          <select id="company-filter" name="company_filter" onchange="this.form.submit()">
            <option value="">All companies</option>
            {% for sponsor_id, company_name in sponsors %}
              <option value="{{ company_name }}" {% if company_filter and company_filter == company_name %}selected{% endif %}>{{ company_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="start-month">Start Month</label>
          <input type="month" id="start-month" name="start_month" value="{{ start_month }}">
        </div>
        <div>
          <label for="end-month">End Month</label>
          <input type="month" id="end-month" name="end_month" value="{{ end_month }}">
        </div>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Apply Filters</button>
        {% if company_filter or start_month or end_month %}
        <a href="{{ url_for('admin.analytics_invoice_log') }}" class="btn btn-secondary">
          <i class="fas fa-undo"></i>
          <span>Clear Filters</span>
        </a>
        {% endif %}
      </div>
    </form>
  </div>

  <div class="admin-card admin-table-card">
    <header>
      <h2>Most Recent Invoices</h2>
      <p class="admin-muted">
        Only the latest generated invoice is shown for each company and billing month.
        {% if start_month or end_month %}
          Showing results{% if start_month %} from <strong>{{ start_month }}</strong>{% endif %}{% if start_month and end_month %} through{% endif %}{% if end_month %} <strong>{{ end_month }}</strong>{% endif %}.
        {% endif %}
      </p>
    </header>
    <div class="table-wrapper">
      <table class="table" id="invoice-log-table">
        <thead>
          <tr>
            <th>Company</th>
            <th>Invoice Month</th>
            <th>Total Orders</th>
            <th>Total Points</th>
            <th>Total Amount</th>
            <th>Generated At</th>
            <th>Generated By</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% if invoice_log %}
            {% for entry in invoice_log %}
              <tr class="invoice-log-row" data-href="{{ url_for('admin.analytics_invoice_detail', invoice_id=entry.invoice_id) }}" style="cursor:pointer;">
                <td data-label="Company">{{ entry.company_name or "—" }}</td>
                <td data-label="Invoice Month">
                  {% if entry.invoice_month %}
                    {{ entry.invoice_month }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td data-label="Total Orders">{{ entry.total_orders }}</td>
                <td data-label="Total Points">{{ "{:,}".format(entry.total_points) }}</td>
                <td data-label="Total Amount">${{ "{:,.2f}".format(entry.total_amount) }}</td>
                <td data-label="Generated At">
                  {% if entry.generated_at %}
                    {{ entry.generated_at | replace("T", " ") }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td data-label="Generated By">{{ entry.generated_by_name or entry.generated_by or "—" }}</td>
                <td data-label="Status">{{ entry.status or "PENDING" }}</td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="8" class="text-center">No invoices have been generated yet.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const rows = document.querySelectorAll('#invoice-log-table .invoice-log-row');
  rows.forEach((row) => {
    row.addEventListener('click', () => {
      const href = row.getAttribute('data-href');
      if (href) {
        window.location.href = href;
      }
    });
  });
});
</script>
{% endblock %}

