{% extends "base.html" %}

{% block title %}Order Confirmation{% endblock %}

{% block content %}
<style>
  .order-confirmation-container {
    padding: clamp(24px, 5vw, 48px);
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
  }

  .order-confirmation-inner {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .success-alert {
    background: linear-gradient(145deg, rgba(16, 185, 129, 0.16), rgba(5, 150, 105, 0.12));
    border: 1px solid rgba(16, 185, 129, 0.35);
    border-radius: 18px;
    padding: clamp(20px, 3vw, 28px);
    box-shadow: 0 18px 40px rgba(15, 23, 42, 0.18);
    backdrop-filter: blur(18px);
  }

  [data-theme="dark"] .success-alert {
    background: linear-gradient(155deg, rgba(5, 150, 105, 0.22), rgba(4, 120, 87, 0.18));
    border-color: rgba(16, 185, 129, 0.42);
    box-shadow: 0 22px 48px rgba(2, 6, 23, 0.55);
  }

  .success-alert h4 {
    color: var(--success);
    font-weight: 700;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .success-alert p {
    color: var(--text-secondary);
    margin: 0;
  }

  .order-content-grid {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 24px;
  }

  @media (max-width: 992px) {
    .order-content-grid {
      grid-template-columns: 1fr;
    }
  }

  .order-card {
    background: linear-gradient(145deg, rgba(41, 51, 73, 0.16), rgba(17, 24, 39, 0.12));
    border: 1px solid rgba(245, 158, 11, 0.28);
    border-radius: 18px;
    padding: clamp(20px, 3vw, 28px);
    box-shadow: 0 18px 40px rgba(15, 23, 42, 0.18);
    backdrop-filter: blur(18px);
  }

  [data-theme="dark"] .order-card {
    background: linear-gradient(155deg, rgba(15, 23, 39, 0.95), rgba(30, 41, 59, 0.92));
    border-color: rgba(245, 158, 11, 0.42);
    box-shadow: 0 22px 48px rgba(2, 6, 23, 0.55);
  }

  .order-card-header {
    border-bottom: 1px solid var(--border);
    padding-bottom: 16px;
    margin-bottom: 20px;
  }

  .order-card-header h5 {
    color: var(--text-primary);
    font-weight: 700;
    font-size: 1.25rem;
    margin: 0;
  }

  .order-detail-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-bottom: 20px;
  }

  @media (max-width: 768px) {
    .order-detail-row {
      grid-template-columns: 1fr;
      gap: 16px;
    }
  }

  .order-detail-item {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .order-detail-item strong {
    color: var(--text-primary);
    font-weight: 600;
    font-size: 0.95rem;
  }

  .order-detail-item span {
    color: var(--text-secondary);
  }

  .theme-badge {
    display: inline-block;
    padding: 6px 14px;
    border-radius: 999px;
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 0.04em;
  }

  .badge-warning {
    background: rgba(245, 158, 11, 0.14);
    border: 1px solid rgba(245, 158, 11, 0.32);
    color: var(--accent);
  }

  .badge-success {
    background: rgba(16, 185, 129, 0.14);
    border: 1px solid rgba(16, 185, 129, 0.32);
    color: var(--success);
  }

  .badge-info {
    background: rgba(59, 130, 246, 0.14);
    border: 1px solid rgba(59, 130, 246, 0.32);
    color: var(--info);
  }

  .badge-secondary {
    background: rgba(148, 163, 184, 0.18);
    border: 1px solid rgba(148, 163, 184, 0.32);
    color: var(--text-secondary);
  }

  .info-alert {
    background: rgba(59, 130, 246, 0.12);
    border: 1px solid rgba(59, 130, 246, 0.35);
    border-radius: 12px;
    padding: 14px 18px;
    color: var(--text-secondary);
    font-size: 0.95rem;
    margin-top: 20px;
  }

  [data-theme="dark"] .info-alert {
    background: rgba(59, 130, 246, 0.18);
    border-color: rgba(59, 130, 246, 0.42);
  }

  .info-alert i {
    color: var(--info);
    margin-right: 8px;
  }

  .info-alert strong {
    color: var(--text-primary);
  }

  .order-items-list {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .order-item {
    display: grid;
    grid-template-columns: 60px 1fr auto auto auto;
    gap: 16px;
    align-items: center;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }

  .order-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }

  @media (max-width: 768px) {
    .order-item {
      grid-template-columns: 50px 1fr;
      gap: 12px;
    }

    .order-item-quantity,
    .order-item-unit,
    .order-item-total {
      grid-column: 2;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
  }

  .order-item-image {
    width: 60px;
    height: 60px;
    background: var(--bg-hover);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--border);
    overflow: hidden;
    flex-shrink: 0;
  }

  .order-item-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .order-item-image-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .order-item-image i {
    color: var(--text-muted);
    font-size: 1.5rem;
  }

  .order-item-clickable {
    cursor: pointer;
    transition: background-color 0.2s ease, transform 0.1s ease;
  }

  .order-item-clickable:hover {
    background-color: var(--bg-hover);
    transform: translateX(2px);
  }

  .order-item-variants {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 4px;
    margin-bottom: 4px;
  }

  .variant-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    background: rgba(148, 163, 184, 0.14);
    border: 1px solid rgba(148, 163, 184, 0.2);
    color: var(--text-secondary);
    font-size: 0.75rem;
    font-weight: 500;
  }

  .order-item-info h6 {
    color: var(--text-primary);
    font-weight: 600;
    margin: 0 0 4px 0;
    font-size: 1rem;
  }

  .order-item-info small {
    color: var(--text-muted);
    font-size: 0.85rem;
  }

  .order-item-quantity,
  .order-item-unit,
  .order-item-total {
    text-align: center;
    color: var(--text-secondary);
  }

  .order-item-total {
    color: var(--accent);
    font-weight: 700;
    font-size: 1.05rem;
  }

  .summary-section {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .summary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: var(--text-secondary);
    font-size: 0.95rem;
  }

  .summary-row strong {
    color: var(--text-primary);
  }

  .summary-total {
    border-top: 1px solid var(--border);
    padding-top: 16px;
    margin-top: 8px;
  }

  .summary-total strong {
    color: var(--accent);
    font-size: 1.15rem;
  }

  .summary-points {
    color: var(--success);
    font-weight: 600;
  }

  .action-buttons {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 20px;
  }

  .action-buttons .btn {
    width: 100%;
    border-radius: 12px;
    font-weight: 600;
    padding: 12px 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s ease;
  }

  .action-buttons .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px var(--shadow-md);
  }

  .btn-outline-primary {
    background-color: transparent;
    border: 2px solid var(--accent);
    color: var(--accent);
  }

  .btn-outline-primary:hover {
    background-color: var(--accent);
    color: var(--text-inverse);
  }

  .section-divider {
    height: 1px;
    background: var(--border);
    margin: 24px 0;
    border: none;
  }

  .order-info-section h6 {
    color: var(--text-primary);
    font-weight: 600;
    margin-bottom: 12px;
    font-size: 1.1rem;
  }

  .order-info-section p {
    color: var(--text-secondary);
    margin-bottom: 16px;
    line-height: 1.6;
  }
</style>

<div class="order-confirmation-container">
  <div class="order-confirmation-inner">
    <div class="success-alert">
      <h4>
        <i class="fas fa-check-circle"></i>
        Order Placed Successfully!
      </h4>
      <p>Thank you for your order. Your order has been processed and points have been deducted from your account.</p>
    </div>

    <div class="order-content-grid">
      <div class="order-details-section">
        <div class="order-card">
          <div class="order-card-header">
            <h5>Order Details</h5>
          </div>
          <div class="order-detail-row">
            <div class="order-detail-item">
              <strong>Order Number:</strong>
              <span>{{ order.OrderNumber }}</span>
            </div>
            <div class="order-detail-item">
              <strong>Order Date:</strong>
              <span>{{ order.CreatedAt.strftime('%B %d, %Y at %I:%M %p') }}</span>
            </div>
          </div>
          <div class="order-detail-row">
            <div class="order-detail-item">
              <strong>Status:</strong>
              <span class="theme-badge badge-warning">{{ order.Status }}</span>
            </div>
            <div class="order-detail-item">
              <strong>Total Points:</strong>
              <span style="color: var(--accent); font-weight: 600;">{{ order.TotalPoints }} pts</span>
            </div>
          </div>
          <div class="order-detail-row">
            <div class="order-detail-item">
              <strong>Payment Method:</strong>
              <span class="theme-badge badge-success">Driver Points</span>
            </div>
            <div class="order-detail-item">
              <strong>Order Type:</strong>
              <span class="theme-badge badge-info">Educational Simulation</span>
            </div>
          </div>

          <hr class="section-divider">

          <div class="order-info-section">
            <h6>Order Information</h6>
            <p>Your order has been successfully placed and points have been deducted from your account.</p>
            <div class="info-alert">
              <i class="fas fa-info-circle"></i>
              <strong>Simulation Notice:</strong> This is an educational project simulation. No real products will be shipped or delivered.
            </div>
          </div>
        </div>

        <div class="order-card" style="margin-top: 24px;">
          <div class="order-card-header">
            <h5>Order Items</h5>
          </div>
          <div class="order-items-list">
            {% for item in order_items %}
            {% set external_id = item.product.ExternalItemID if item.product else '' %}
            {% set base_item_id = external_id.split('::')[0] if external_id and '::' in external_id else external_id %}
            {% set item_url = url_for('driver_points_catalog.product_detail', item_id=base_item_id|urlencode) if base_item_id and base_item_id != 'SHIPPING' else '#' %}
            <div class="order-item {% if base_item_id and base_item_id != 'SHIPPING' %}order-item-clickable{% endif %}" {% if base_item_id and base_item_id != 'SHIPPING' %}onclick="window.location.href='{{ item_url }}'"{% endif %}>
              <div class="order-item-image">
                {% if base_item_id and base_item_id != 'SHIPPING' %}
                <img src="" 
                     alt="{{ item.Title }}"
                     class="order-item-img"
                     data-item-id="{{ base_item_id|urlencode }}"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="order-item-image-placeholder" style="display: none;">
                  <i class="fas fa-box"></i>
                </div>
                {% else %}
                <div class="order-item-image-placeholder">
                  <i class="fas fa-box"></i>
                </div>
                {% endif %}
              </div>
              <div class="order-item-info">
                <h6>{{ item.Title }}</h6>
                {% if external_id and '::' in external_id %}
                {% set variant_part = external_id.split('::', 1)[1] %}
                {% set variant_map = {} %}
                {% for pair in variant_part.split('|') %}
                    {% set key_value = pair.split(':', 1) %}
                    {% if key_value|length == 2 %}
                        {% set _ = variant_map.update({key_value[0]: key_value[1]}) %}
                    {% endif %}
                {% endfor %}
                {% if variant_map %}
                <div class="order-item-variants">
                  {% for key, value in variant_map.items() %}
                  <span class="variant-badge">{{ key }}: {{ value }}</span>
                  {% endfor %}
                </div>
                {% endif %}
                {% endif %}
                <small>Product ID: {{ item.ProductID }}</small>
              </div>
              <div class="order-item-quantity">
                <span class="theme-badge badge-secondary">{{ item.Quantity }}</span>
              </div>
              <div class="order-item-unit">
                <span>{{ item.UnitPoints }} pts</span>
              </div>
              <div class="order-item-total">
                {{ item.LineTotalPoints }} pts
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="order-summary-section">
        <div class="order-card">
          <div class="order-card-header">
            <h5>Order Summary</h5>
          </div>
          <div class="summary-section">
            <div class="summary-row">
              <span>Items ({{ order_items|length }}):</span>
              <span>{{ order.TotalPoints }} pts</span>
            </div>
            <hr class="section-divider">
            <div class="summary-row summary-total">
              <strong>Total:</strong>
              <strong>{{ order.TotalPoints }} pts</strong>
            </div>
            <div class="summary-row">
              <span>Remaining Points:</span>
              <span class="summary-points">{{ driver_points }} pts</span>
            </div>

            <div class="action-buttons">
              <a href="{{ url_for('orders.view_orders') }}" class="btn btn-primary">
                <i class="fas fa-list"></i>
                View Order History
              </a>
              <a href="{{ url_for('driver_points_catalog.browse') }}" class="btn btn-outline-primary">
                <i class="fas fa-shopping-bag"></i>
                Continue Shopping
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Load product images
document.addEventListener('DOMContentLoaded', function() {
    const itemImages = document.querySelectorAll('.order-item-img[data-item-id]');
    
    itemImages.forEach(function(img) {
        const itemId = img.getAttribute('data-item-id');
        if (!itemId) return;
        
        // Fetch image from API
        fetch(`/catalog/item/ebay/${encodeURIComponent(itemId)}/images`)
            .then(response => {
                if (!response.ok) throw new Error('Image not found');
                return response.json();
            })
            .then(data => {
                if (data.images && data.images.length > 0) {
                    img.src = data.images[0];
                } else {
                    throw new Error('No images available');
                }
            })
            .catch(error => {
                // Show placeholder on error
                img.style.display = 'none';
                const placeholder = img.nextElementSibling;
                if (placeholder && placeholder.classList.contains('order-item-image-placeholder')) {
                    placeholder.style.display = 'flex';
                }
            });
    });
});
</script>
{% endblock %}
